<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTracker Pro - Auto-Sync</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" sizes="192x192" href="time-tracker-grid-icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="time-tracker-grid-icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
            margin-top: 12px;
        }

        .date-input {
            padding: 6px 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            white-space: nowrap;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .sync-status {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
        }

        .sync-dot.connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .sync-dot.syncing {
            background: #f59e0b;
            animation: spin 1s linear infinite;
        }

        .sync-dot.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background: white;
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #475569;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Daily View Styles */
        .activity-selector {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .activity-selector h3 {
            margin-bottom: 12px;
            color: #1e293b;
            font-size: 16px;
        }

        .activity-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .activity-btn {
            width: 44px;
            height: 44px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .activity-btn:hover {
            border-color: #2563eb;
            transform: translateY(-1px);
        }

        .activity-btn.selected {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .time-grid {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr);
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .grid-header div {
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #374151;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr);
            border-bottom: 1px solid #e5e7eb;
        }

        .grid-row:nth-child(even) {
            background: #f9fafb;
        }

        .hour-label {
            padding: 6px 4px;
            background: #f1f5f9;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .time-cell {
            padding: 6px 4px;
            border-right: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            min-height: 32px;
        }

        .time-cell:hover {
            background: #dbeafe;
        }

        .time-cell.filled {
            background: #bfdbfe;
            color: #1e40af;
        }

        /* Weekly View Styles (formerly 5-day) */
        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .week-nav-btn {
            padding: 8px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .week-nav-btn:hover {
            background: #1d4ed8;
        }

        .week-range {
            font-weight: 600;
            color: #1e293b;
        }

        .weekly-grid {
            background: white;
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .weekly-header {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 11px;
            min-width: 700px;
        }

        .weekly-header div {
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #374151;
        }

        .weekly-row {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            border-bottom: 1px solid #e5e7eb;
            min-width: 700px;
        }

        .weekly-row:nth-child(even) {
            background: #f9fafb;
        }

        .weekly-hour {
            padding: 4px 2px;
            background: #f1f5f9;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }

        .weekly-cell {
            border: 1px solid #e5e7eb;
            background: white;
            min-height: 40px;
            padding: 2px;
            position: relative;
        }

        .weekly-cell.has-data {
            background: #f0f9ff;
        }

        .interval-container {
            width: 100%;
            height: 100%;
            min-height: 36px;
        }

        .interval-quarter {
            min-height: 16px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .interval-quarter:hover {
            background: #bbdefb !important;
        }

        /* Habits View Styles */
        .habits-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .habits-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .habits-nav-btn {
            padding: 8px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .habits-nav-btn:hover {
            background: #1d4ed8;
        }

        .habits-period {
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }

        .habits-grid {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .habits-header {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .habits-header div {
            padding: 10px 4px;
            text-align: center;
            border-right: 1px solid #374151;
        }

        .habits-row {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            border-bottom: 1px solid #e5e7eb;
        }

        .habits-row:nth-child(even) {
            background: #f9fafb;
        }

        .habit-label {
            padding: 12px 8px;
            background: #f1f5f9;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .habit-cell {
            padding: 8px;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .habit-cell:hover {
            background: #dbeafe;
        }

        .habit-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .habit-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .habit-checkbox.half {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }

        .summary {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .summary h3 {
            margin-bottom: 12px;
            color: #1e293b;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
        }

        .summary-item .symbol {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .summary-item .count {
            font-size: 12px;
            color: #64748b;
        }

        .setup-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .setup-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .sync-preferences {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .sync-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sync-option:hover {
            background: #e2e8f0;
        }

        .sync-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .alert {
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 13px;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .debug-info {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            margin: 8px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .onedrive-setup {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .sign-in-btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .sign-in-btn:hover {
            background: #106ebe;
        }

        .sign-in-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 4px;
            }

            .container {
                border-radius: 8px;
                min-height: calc(100vh - 8px);
            }

            .header {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .controls {
                gap: 6px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .main-content {
                padding: 12px;
            }

            .nav-tab {
                padding: 10px 6px;
                font-size: 12px;
            }

            .activity-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 50px repeat(4, 1fr);
            }

            .grid-header div,
            .time-cell,
            .hour-label {
                padding: 4px 2px;
                font-size: 10px;
            }

            .time-cell {
                min-height: 28px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .habits-header,
            .habits-row {
                grid-template-columns: 100px repeat(7, 1fr);
            }

            .habits-header div {
                padding: 8px 2px;
                font-size: 10px;
            }

            .habit-label {
                padding: 8px 4px;
                font-size: 11px;
            }

            .habit-cell {
                padding: 6px 2px;
                min-height: 36px;
            }

            .habit-checkbox {
                width: 16px;
                height: 16px;
            }

            .weekly-grid {
                font-size: 9px;
            }
            
            .weekly-header,
            .weekly-row {
                min-width: 600px;
            }
        }

        /* Large screens */
        @media (min-width: 1200px) {
            .main-content {
                padding: 24px;
            }

            .activity-btn {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }

            .time-cell {
                min-height: 36px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TimeTracker Pro</h1>
            <div class="controls">
                <input type="date" id="dateInput" class="date-input">
                <button class="btn btn-primary" onclick="exportData()">📤 Export</button>
                <button class="btn btn-primary" onclick="importData()">📥 Import</button>
                <button class="btn btn-primary" onclick="showSetup()">⚙️ Setup</button>
                <button class="btn btn-danger" onclick="clearDay()">🗑️ Clear</button>
            </div>
            <div class="sync-status">
                <div>
                    <div class="sync-indicator">
                        <div class="sync-dot" id="githubDot"></div>
                        <span>GitHub: <span id="githubStatus">Auto-sync disabled</span></span>
                    </div>
                    <div class="sync-indicator">
                        <div class="sync-dot" id="onedriveDot"></div>
                        <span>OneDrive: <span id="onedriveStatus">Loading...</span></span>
                    </div>
                </div>
                <div id="lastSync" style="font-size: 9px; opacity: 0.8;"></div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('daily')">📝 Daily</button>
            <button class="nav-tab" onclick="switchView('weekly')">📅 Weekly</button>
            <button class="nav-tab" onclick="switchView('habits')">📊 Habits</button>
        </div>

        <div class="main-content">
            <!-- Daily View -->
            <div id="dailyView" class="view active">
                <div class="activity-selector">
                    <h3>Select Activity Symbol</h3>
                    <div class="activity-buttons">
                        <div class="activity-btn" data-symbol="●" title="Wake up">●</div>
                        <div class="activity-btn" data-symbol="✓" title="Working">✓</div>
                        <div class="activity-btn" data-symbol="P" title="Pomodoro">P</div>
                        <div class="activity-btn" data-symbol="M" title="Meditation">M</div>
                        <div class="activity-btn" data-symbol="J" title="Jogging">J</div>
                        <div class="activity-btn" data-symbol="○" title="Social">○</div>
                        <div class="activity-btn" data-symbol="×" title="Clear">×</div>
                    </div>
                </div>

                <div class="time-grid">
                    <div class="grid-header">
                        <div>Hour</div>
                        <div>00-15</div>
                        <div>15-30</div>
                        <div>30-45</div>
                        <div>45-00</div>
                    </div>
                    <div id="timeGrid"></div>
                </div>

                <div class="summary">
                    <h3>Daily Summary</h3>
                    <div id="summaryContent" class="summary-grid"></div>
                </div>
            </div>

            <!-- Weekly View (formerly 5-Day) -->
            <div id="weeklyView" class="view">
                <div class="week-navigation">
                    <button class="week-nav-btn" onclick="navigateWeek(-1)">← Previous</button>
                    <div class="week-range" id="weekRange"></div>
                    <button class="week-nav-btn" onclick="navigateWeek(1)">Next →</button>
                </div>

                <div class="weekly-grid">
                    <div class="weekly-header" id="weeklyHeader"></div>
                    <div id="weeklyGrid"></div>
                </div>
            </div>

            <!-- Habits View -->
            <div id="habitsView" class="view">
                <div class="habits-container">
                    <div class="habits-navigation">
                        <button class="habits-nav-btn" onclick="navigateHabits(-1)">← Previous</button>
                        <div class="habits-period" id="habitsPeriod"></div>
                        <button class="habits-nav-btn" onclick="navigateHabits(1)">Next →</button>
                    </div>

                    <div style="text-align: center; margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="syncAllHabitsFromTimeLog(); updateHabitsView(); showAlert('Habits synced from time log!', 'success');">
                            🔄 Sync Habits from Time Log
                        </button>
                    </div>

                    <div class="habits-grid" id="habitsGrid1"></div>
                    <div class="habits-grid" id="habitsGrid2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Panel -->
    <div id="setupPanel" class="setup-panel">
        <div class="setup-content">
            <h2>Sync Configuration & Preferences</h2>
            
            <div class="sync-preferences">
                <h3>🔄 Auto-Sync Preferences</h3>
                <p>Choose which platforms to automatically sync your data with:</p>
                
                <div class="sync-option" onclick="toggleSyncPreference('github')">
                    <input type="checkbox" id="githubSync" onchange="updateSyncPreferences()">
                    <div>
                        <strong>📁 GitHub Auto-Sync</strong><br>
                        <small>Automatic backup with version control</small>
                    </div>
                </div>
                
                <div class="sync-option" onclick="toggleSyncPreference('onedrive')">
                    <input type="checkbox" id="onedriveSync" onchange="updateSyncPreferences()">
                    <div>
                        <strong>☁️ OneDrive Auto-Sync</strong><br>
                        <small>Real-time cross-device synchronization</small>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 8px; background: #e0f2fe; border-radius: 4px; font-size: 12px;">
                    <strong>💡 Tip:</strong> You can enable both for maximum redundancy. OneDrive provides real-time sync, while GitHub offers version control and backup.
                </div>
            </div>
            
            <div id="debugInfo" class="debug-info">
                <strong>Status:</strong><br>
                <span id="debugLog">Initializing...</span>
            </div>
            
            <div id="onedriveSetup" class="onedrive-setup">
                <h3>☁️ OneDrive Authentication</h3>
                <p>Connect your Microsoft account for seamless cross-device sync.</p>
                
                <div style="margin: 16px 0;">
                    <div id="onedriveAuthStatus" style="margin-bottom: 12px;">Status: Loading...</div>
                    
                    <button class="sign-in-btn" id="signInBtn" onclick="signInToOneDrive()" disabled>
                        <span>🔄</span>
                        <span>Loading Microsoft Sign-In...</span>
                    </button>
                    
                    <div id="signedInControls" style="display: none; margin-top: 12px;">
                        <button class="btn btn-success" onclick="testOneDriveConnection()" id="testOnedriveBtn">
                            🔗 Test Connection
                        </button>
                        <button class="btn btn-danger" onclick="signOutFromOneDrive()" id="signOutBtn">
                            🚪 Sign Out
                        </button>
                    </div>
                </div>
                
                <div id="onedriveResult"></div>
            </div>

            <div style="margin-top: 20px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 16px;">
                <button class="btn btn-primary" onclick="hideSetup()" style="padding: 10px 24px; font-size: 14px; font-weight: 600;">
                    ✕ Close Setup
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedSymbol = '●';
        let currentDate = new Date().toISOString().split('T')[0];
        let currentWeekStart = new Date();
        let currentHabitsWeek = new Date();
        let timeData = {};
        let habitsData = {};
        let msalInstance = null;
        let currentAccount = null;
        let debugLog = [];
        let msalLoadAttempts = 0;
        let currentView = 'daily';
        let syncPreferences = {
            github: false,
            onedrive: false,
            autoSyncInterval: 30000 // 30 seconds
        };
        let autoSyncTimer = null;
        let pendingChanges = false;
        let lastSyncTime = null;

        // Habits configuration
        const habitsConfig = [
            { id: 'reading', name: 'Reading', autoDetect: false },
            { id: 'oatmeal', name: 'Oatmeal', autoDetect: false },
            { id: 'jogging', name: 'Jogging', autoDetect: 'J' },
            { id: 'writing', name: 'Writing', autoDetect: false },
            { id: 'meditation', name: 'Meditation', autoDetect: 'M' },
            { id: 'stretching', name: 'Stretching', autoDetect: false },
            { id: 'nodrink', name: 'No Drink', autoDetect: false }
        ];

        // Debug logging function
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            const debugElement = document.getElementById('debugLog');
            if (debugElement) {
                debugElement.innerHTML = debugLog.slice(-8).join('<br>');
            }
            console.log(`[TimeTracker] ${message}`);
        }

        // MSAL CDN sources to try
        const msalCDNSources = [
            'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
            'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
            'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/msal/2.38.3/msal-browser.min.js'
        ];

        // Load MSAL library with fallback
        function loadMSALLibrary() {
            if (msalLoadAttempts >= msalCDNSources.length) {
                addDebugLog('❌ All MSAL CDN sources failed');
                updateAuthStatus('MSAL library could not be loaded');
                return;
            }

            const cdnUrl = msalCDNSources[msalLoadAttempts];
            addDebugLog(`Trying CDN ${msalLoadAttempts + 1}: ${cdnUrl.split('/')[2]}`);

            const script = document.createElement('script');
            script.src = cdnUrl;
            script.async = true;
            
            script.onload = function() {
                addDebugLog(`✅ MSAL loaded from CDN ${msalLoadAttempts + 1}`);
                initializeMSAL();
            };
            
            script.onerror = function() {
                addDebugLog(`❌ CDN ${msalLoadAttempts + 1} failed, trying next...`);
                msalLoadAttempts++;
                setTimeout(() => loadMSALLibrary(), 1000);
            };
            
            document.head.appendChild(script);
        }

        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: 'd006fc96-89ce-4dbe-8bd1-78daab15c1df',
                authority: 'https://login.microsoftonline.com/common'
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        // Login request configuration
        const loginRequest = {
            scopes: ['https://graph.microsoft.com/Files.ReadWrite', 'https://graph.microsoft.com/User.Read']
        };

        // Initialize MSAL instance
        async function initializeMSAL() {
            addDebugLog('Starting MSAL initialization...');
            
            if (typeof msal === 'undefined') {
                addDebugLog('❌ MSAL not available after loading');
                updateAuthStatus('MSAL library not available');
                return;
            }

            try {
                addDebugLog('Creating MSAL instance...');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                
                addDebugLog('Initializing MSAL...');
                await msalInstance.initialize();
                
                addDebugLog('✅ MSAL initialized successfully');
                
                // Check if user is already signed in
                const accounts = msalInstance.getAllAccounts();
                addDebugLog(`Found ${accounts.length} existing accounts`);
                
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    msalInstance.setActiveAccount(currentAccount);
                    addDebugLog(`✅ Using existing account: ${currentAccount.username}`);
                }
                
                updateAuthStatus();
                
                // Start auto-sync if OneDrive is enabled
                if (syncPreferences.onedrive && currentAccount) {
                    startAutoSync();
                }
                
            } catch (error) {
                addDebugLog(`❌ MSAL initialization failed: ${error.message}`);
                console.error('MSAL initialization failed:', error);
                updateAuthStatus('Authentication initialization failed');
            }
        }

        // Auto-sync functions
        function startAutoSync() {
            if (autoSyncTimer) {
                clearInterval(autoSyncTimer);
            }
            
            addDebugLog('Starting auto-sync timer');
            autoSyncTimer = setInterval(() => {
                if (pendingChanges) {
                    performAutoSync();
                }
            }, syncPreferences.autoSyncInterval);
        }

        function stopAutoSync() {
            if (autoSyncTimer) {
                clearInterval(autoSyncTimer);
                autoSyncTimer = null;
                addDebugLog('Auto-sync timer stopped');
            }
        }

        async function performAutoSync() {
            if (!pendingChanges) return;
            
            try {
                updateSyncStatus('syncing');
                
                // Sync to enabled platforms
                const promises = [];
                
                if (syncPreferences.onedrive && currentAccount) {
                    promises.push(syncToOneDriveAuto());
                }
                
                if (syncPreferences.github) {
                    promises.push(syncToGitHubAuto());
                }
                
                await Promise.all(promises);
                
                pendingChanges = false;
                lastSyncTime = new Date();
                updateSyncStatus('synced');
                updateLastSyncDisplay();
                
                addDebugLog('✅ Auto-sync completed successfully');
                
            } catch (error) {
                addDebugLog(`❌ Auto-sync failed: ${error.message}`);
                updateSyncStatus('error');
            }
        }

        function markDataChanged() {
            pendingChanges = true;
            updateSyncStatus('pending');
        }

        function updateSyncStatus(status) {
            const githubDot = document.getElementById('githubDot');
            const onedriveDot = document.getElementById('onedriveDot');
            const githubStatus = document.getElementById('githubStatus');
            const onedriveStatus = document.getElementById('onedriveStatus');
            
            // Update GitHub status
            if (syncPreferences.github) {
                githubDot.className = `sync-dot ${status}`;
                switch (status) {
                    case 'syncing':
                        githubStatus.textContent = 'Syncing...';
                        break;
                    case 'synced':
                        githubStatus.textContent = 'Auto-sync enabled';
                        break;
                    case 'error':
                        githubStatus.textContent = 'Sync error';
                        break;
                    case 'pending':
                        githubStatus.textContent = 'Changes pending';
                        break;
                }
            } else {
                githubDot.className = 'sync-dot';
                githubStatus.textContent = 'Auto-sync disabled';
            }
            
            // Update OneDrive status
            if (syncPreferences.onedrive && currentAccount) {
                onedriveDot.className = `sync-dot ${status}`;
                switch (status) {
                    case 'syncing':
                        onedriveStatus.textContent = 'Syncing...';
                        break;
                    case 'synced':
                        onedriveStatus.textContent = `Connected as ${currentAccount.username}`;
                        break;
                    case 'error':
                        onedriveStatus.textContent = 'Sync error';
                        break;
                    case 'pending':
                        onedriveStatus.textContent = 'Changes pending';
                        break;
                }
            } else if (currentAccount) {
                onedriveDot.className = 'sync-dot';
                onedriveStatus.textContent = 'Auto-sync disabled';
            } else {
                onedriveDot.className = 'sync-dot';
                onedriveStatus.textContent = 'Not connected';
            }
        }

        function updateLastSyncDisplay() {
            const lastSyncElement = document.getElementById('lastSync');
            if (lastSyncTime) {
                lastSyncElement.textContent = `Last sync: ${lastSyncTime.toLocaleTimeString()}`;
            } else {
                lastSyncElement.textContent = '';
            }
        }

        // Sync preferences management
        function loadSyncPreferences() {
            const saved = localStorage.getItem('syncPreferences');
            if (saved) {
                syncPreferences = { ...syncPreferences, ...JSON.parse(saved) };
            }
            
            // Update UI
            document.getElementById('githubSync').checked = syncPreferences.github;
            document.getElementById('onedriveSync').checked = syncPreferences.onedrive;
        }

        function saveSyncPreferences() {
            localStorage.setItem('syncPreferences', JSON.stringify(syncPreferences));
        }

        function toggleSyncPreference(platform) {
            const checkbox = document.getElementById(platform + 'Sync');
            checkbox.checked = !checkbox.checked;
            updateSyncPreferences();
        }

        function updateSyncPreferences() {
            syncPreferences.github = document.getElementById('githubSync').checked;
            syncPreferences.onedrive = document.getElementById('onedriveSync').checked;
            
            saveSyncPreferences();
            
            // Update auto-sync behavior
            if (syncPreferences.onedrive && currentAccount) {
                startAutoSync();
            } else if (!syncPreferences.github && !syncPreferences.onedrive) {
                stopAutoSync();
            }
            
            updateSyncStatus('pending');
            addDebugLog(`Sync preferences updated: GitHub=${syncPreferences.github}, OneDrive=${syncPreferences.onedrive}`);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('DOM loaded, initializing app...');
            
            // Set current week start to Monday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + mondayOffset);
            
            // Set habits week to current week
            currentHabitsWeek = new Date(currentWeekStart);
            
            document.getElementById('dateInput').value = currentDate;
            loadSyncPreferences();
            loadTimeData();
            loadHabitsData();
            
            // Sync habits from existing time log data on app load
            syncAllHabitsFromTimeLog();
            
            generateTimeGrid();
            updateSummary();
            setupEventListeners();
            updateWeeklyView();
            updateHabitsView();
            updateSyncStatus('pending');
            
            // Start loading MSAL library
            setTimeout(() => {
                loadMSALLibrary();
            }, 500);
            
            // Auto-load from enabled sync platforms
            setTimeout(() => {
                autoLoadFromSyncPlatforms();
            }, 2000);
        });

        async function autoLoadFromSyncPlatforms() {
            try {
                if (syncPreferences.onedrive && currentAccount) {
                    await loadFromOneDriveAuto();
                }
                
                if (syncPreferences.github) {
                    await loadFromGitHubAuto();
                }
                
                // Refresh views after loading
                generateTimeGrid();
                updateSummary();
                updateWeeklyView();
                updateHabitsView();
                
            } catch (error) {
                addDebugLog(`Auto-load failed: ${error.message}`);
            }
        }

        function setupEventListeners() {
            // Date change
            document.getElementById('dateInput').addEventListener('change', function() {
                currentDate = this.value;
                loadTimeData();
                generateTimeGrid();
                updateSummary();
                if (currentView === 'weekly') {
                    updateWeeklyView();
                }
                if (currentView === 'habits') {
                    updateHabitsView();
                }
            });

            // Activity button selection
            document.querySelectorAll('.activity-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSymbol = this.dataset.symbol;
                });
            });

            // Select first activity by default
            document.querySelector('.activity-btn').classList.add('selected');
        }

        // View switching
        function switchView(viewName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update views
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            
            currentView = viewName;
            
            // Update view-specific content
            if (viewName === 'weekly') {
                updateWeeklyView();
            } else if (viewName === 'habits') {
                // Auto-sync habits from time log when switching to habits view
                syncAllHabitsFromTimeLog();
                updateHabitsView();
            }
        }

        // Date utilities
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateDisplay(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        // Generate time grid for daily view
        function generateTimeGrid() {
            const grid = document.getElementById('timeGrid');
            grid.innerHTML = '';

            const hours = [];
            for (let i = 5; i < 24; i++) {
                hours.push(String(i).padStart(2, '0') + ':00');
            }
            for (let i = 0; i < 5; i++) {
                hours.push(String(i).padStart(2, '0') + ':00');
            }

            hours.forEach(hour => {
                const row = document.createElement('div');
                row.className = 'grid-row';

                const hourLabel = document.createElement('div');
                hourLabel.className = 'hour-label';
                hourLabel.textContent = hour;
                row.appendChild(hourLabel);

                for (let interval = 0; interval < 4; interval++) {
                    const cell = document.createElement('div');
                    cell.className = 'time-cell';
                    cell.dataset.hour = hour;
                    cell.dataset.interval = interval;

                    const key = `${hour}-${interval}`;
                    const data = timeData[currentDate]?.[key];
                    if (data) {
                        cell.textContent = data.symbol || data;
                        cell.classList.add('filled');
                    }

                    cell.addEventListener('click', function() {
                        handleCellClick(this);
                    });

                    row.appendChild(cell);
                }

                grid.appendChild(row);
            });
        }

        function handleCellClick(cell) {
            const hour = cell.dataset.hour;
            const interval = cell.dataset.interval;
            const key = `${hour}-${interval}`;

            if (!timeData[currentDate]) {
                timeData[currentDate] = {};
            }

            if (selectedSymbol === '×') {
                // Clear cell
                delete timeData[currentDate][key];
                cell.textContent = '';
                cell.classList.remove('filled');
            } else {
                // Set symbol
                timeData[currentDate][key] = {
                    symbol: selectedSymbol,
                    timestamp: new Date().toISOString(),
                    device: getDeviceFingerprint()
                };
                cell.textContent = selectedSymbol;
                cell.classList.add('filled');
            }

            saveTimeData();
            updateSummary();
            updateHabitsFromTimeLog(currentDate);
            markDataChanged();
            
            // Update other views if they're visible
            if (currentView === 'weekly') {
                updateWeeklyView();
            } else if (currentView === 'habits') {
                updateHabitsView();
            }
        }

        function getDeviceFingerprint() {
            return navigator.userAgent.substring(0, 50) + '_' + screen.width + 'x' + screen.height;
        }

        // Update summary
        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const dayData = timeData[currentDate] || {};
            
            const symbolCounts = {};
            Object.values(dayData).forEach(entry => {
                const symbol = entry.symbol || entry;
                symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
            });

            const symbolNames = {
                '●': 'Woke up',
                '✓': 'Working',
                'P': 'Pomodoro',
                'M': 'Meditation',
                'J': 'Jogging',
                '○': 'Social'
            };

            summaryContent.innerHTML = '';
            Object.entries(symbolNames).forEach(([symbol, name]) => {
                const count = symbolCounts[symbol] || 0;
                const item = document.createElement('div');
                item.className = 'summary-item';
                
                if (symbol === '●') {
                    item.innerHTML = `
                        <div class="symbol">${symbol} ${name}</div>
                        <div class="count">${count > 0 ? 'Marked' : 'Not set'}</div>
                    `;
                } else {
                    const hours = Math.floor(count * 15 / 60);
                    const minutes = (count * 15) % 60;
                    item.innerHTML = `
                        <div class="symbol">${symbol} ${name}</div>
                        <div class="count">${count} slots (${hours}h ${minutes}m)</div>
                    `;
                }
                
                summaryContent.appendChild(item);
            });
        }

        // Weekly View Functions (formerly 5-day)
        function navigateWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            updateWeeklyView();
        }

        function updateWeeklyView() {
            const header = document.getElementById('weeklyHeader');
            const grid = document.getElementById('weeklyGrid');
            const weekRange = document.getElementById('weekRange');
            
            // Update week range display (Monday to Sunday)
            const endDate = addDays(currentWeekStart, 6);
            weekRange.textContent = `${formatDateDisplay(currentWeekStart)} - ${formatDateDisplay(endDate)}`;
            
            // Debug: Log the week dates
            console.log('=== Weekly View Date Mapping ===');
            console.log('Current week start (Monday):', formatDate(currentWeekStart));
            
            // Generate header (7 days: Mon-Sun)
            header.innerHTML = '<div>Hour</div>';
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = addDays(currentWeekStart, i);
                const dateStr = formatDate(date);
                weekDates.push(dateStr);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate().toString().padStart(2, '0');
                header.innerHTML += `<div>${dayName}<br>${dayNum}</div>`;
                console.log(`Column ${i}: ${dayName} ${dayNum} (${dateStr})`);
            }
            
            // Generate grid
            grid.innerHTML = '';
            const hours = [];
            for (let i = 5; i < 24; i++) {
                hours.push(String(i).padStart(2, '0') + ':00');
            }
            for (let i = 0; i < 5; i++) {
                hours.push(String(i).padStart(2, '0') + ':00');
            }

            hours.forEach(hour => {
                const row = document.createElement('div');
                row.className = 'weekly-row';

                const hourLabel = document.createElement('div');
                hourLabel.className = 'weekly-hour';
                hourLabel.textContent = hour;
                row.appendChild(hourLabel);

                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const date = formatDate(addDays(currentWeekStart, dayOffset));
                    const dayData = timeData[date] || {};
                    
                    // Debug: Log data lookup
                    if (Object.keys(dayData).length > 0) {
                        console.log(`Found data for ${date} (column ${dayOffset}):`, Object.keys(dayData));
                    }
                    
                    const cell = document.createElement('div');
                    cell.className = 'weekly-cell';
                    
                    // Create 4 interval quarters within each hour cell
                    const intervalContainer = document.createElement('div');
                    intervalContainer.className = 'interval-container';
                    intervalContainer.style.cssText = `
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        grid-template-rows: 1fr 1fr;
                        height: 100%;
                        gap: 1px;
                    `;
                    
                    // Check each 15-minute interval
                    for (let interval = 0; interval < 4; interval++) {
                        const key = `${hour}-${interval}`;
                        const data = dayData[key];
                        
                        const intervalCell = document.createElement('div');
                        intervalCell.className = 'interval-quarter';
                        intervalCell.style.cssText = `
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            font-weight: bold;
                            background: ${data ? '#e3f2fd' : 'transparent'};
                            border-radius: 2px;
                        `;
                        
                        if (data) {
                            const symbol = data.symbol || data;
                            intervalCell.textContent = symbol;
                            intervalCell.title = `${hour}:${(interval * 15).toString().padStart(2, '0')}-${((interval + 1) * 15).toString().padStart(2, '0')} - ${symbol}`;
                            console.log(`Hour ${hour}, Date ${date}, Interval ${interval}: ${symbol}`);
                        }
                        
                        intervalContainer.appendChild(intervalCell);
                    }
                    
                    // If any data exists, mark the cell as having data
                    const hasAnyData = [0, 1, 2, 3].some(interval => {
                        const key = `${hour}-${interval}`;
                        return dayData[key];
                    });
                    
                    if (hasAnyData) {
                        cell.classList.add('has-data');
                    }
                    
                    cell.appendChild(intervalContainer);
                    row.appendChild(cell);
                }

                grid.appendChild(row);
            });
        }

        // Habits Functions
        function navigateHabits(direction) {
            currentHabitsWeek.setDate(currentHabitsWeek.getDate() + (direction * 14));
            updateHabitsView();
        }

        function updateHabitsView() {
            const period = document.getElementById('habitsPeriod');
            const grid1 = document.getElementById('habitsGrid1');
            const grid2 = document.getElementById('habitsGrid2');
            
            // Update period display
            const week1Start = new Date(currentHabitsWeek);
            const week1End = addDays(week1Start, 6);
            const week2Start = addDays(week1Start, 7);
            const week2End = addDays(week1Start, 13);
            
            period.innerHTML = `
                Week 1: ${formatDateDisplay(week1Start)} - ${formatDateDisplay(week1End)}<br>
                Week 2: ${formatDateDisplay(week2Start)} - ${formatDateDisplay(week2End)}
            `;
            
            // Generate both weeks
            generateHabitsGrid(grid1, week1Start);
            generateHabitsGrid(grid2, week2Start);
        }

        function generateHabitsGrid(container, weekStart) {
            // Debug: Log the week start and dates
            console.log('=== Habits Grid Date Mapping ===');
            console.log('Week start:', formatDate(weekStart));
            
            // Generate header
            let headerHTML = '<div>Habit</div>';
            const weekDates = []; // Store actual dates for debugging
            
            for (let i = 0; i < 7; i++) {
                const date = addDays(weekStart, i);
                const dateStr = formatDate(date);
                weekDates.push(dateStr); // Store for debugging
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate().toString().padStart(2, '0');
                headerHTML += `<div>${dayName}<br>${dayNum}</div>`;
                console.log(`Habits column ${i}: ${dayName} ${dayNum} (${dateStr})`);
            }
            
            // Generate rows
            let rowsHTML = '';
            habitsConfig.forEach(habit => {
                rowsHTML += '<div class="habits-row">';
                rowsHTML += `<div class="habit-label">${habit.name}</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const date = formatDate(addDays(weekStart, i));
                    const habitValue = getHabitValue(date, habit.id);
                    
                    // Debug: Log habit data for meditation and any found values
                    if (habit.id === 'meditation' && habitValue) {
                        console.log(`Meditation habit found for ${date} (column ${i}): ${habitValue}`);
                    }
                    if (habitValue) {
                        console.log(`${habit.name} habit for ${date} (column ${i}): ${habitValue}`);
                    }
                    
                    rowsHTML += `<div class="habit-cell" onclick="toggleHabit('${date}', '${habit.id}')">`;
                    rowsHTML += `<div class="habit-checkbox ${habitValue}" data-date="${date}" data-habit="${habit.id}">`;
                    if (habitValue === 'checked') {
                        rowsHTML += '✓';
                    } else if (habitValue === 'half') {
                        rowsHTML += '½';
                    }
                    rowsHTML += '</div></div>';
                }
                
                rowsHTML += '</div>';
            });
            
            container.innerHTML = `
                <div class="habits-header">${headerHTML}</div>
                ${rowsHTML}
            `;
        }

        function getHabitValue(date, habitId) {
            if (!habitsData[date]) return '';
            const value = habitsData[date][habitId];
            if (value === true) return 'checked';
            if (value === 'half') return 'half';
            return '';
        }

        function toggleHabit(date, habitId) {
            if (!habitsData[date]) {
                habitsData[date] = {};
            }
            
            const current = habitsData[date][habitId];
            
            // Cycle through: empty -> checked -> half -> empty
            if (!current) {
                habitsData[date][habitId] = true;
            } else if (current === true) {
                habitsData[date][habitId] = 'half';
            } else {
                delete habitsData[date][habitId];
            }
            
            saveHabitsData();
            updateHabitsView();
            markDataChanged();
        }

        function updateHabitsFromTimeLog(date) {
            if (!habitsData[date]) {
                habitsData[date] = {};
            }
            
            const dayData = timeData[date] || {};
            const symbols = Object.values(dayData).map(entry => entry.symbol || entry);
            
            // Auto-detect habits from time log
            habitsConfig.forEach(habit => {
                if (habit.autoDetect && symbols.includes(habit.autoDetect)) {
                    habitsData[date][habit.id] = true;
                }
            });
            
            saveHabitsData();
        }

        // Sync all existing time log data to habits (retroactive detection)
        function syncAllHabitsFromTimeLog() {
            let syncCount = 0;
            
            console.log('=== Syncing habits from time log ===');
            console.log('Available time data dates:', Object.keys(timeData));
            console.log('Current habits data:', habitsData);
            
            // Go through all dates in time data
            Object.keys(timeData).forEach(date => {
                const dayData = timeData[date] || {};
                const symbols = Object.values(dayData).map(entry => entry.symbol || entry);
                
                console.log(`Processing date ${date}, symbols:`, symbols);
                
                if (!habitsData[date]) {
                    habitsData[date] = {};
                }
                
                // Auto-detect habits from time log for this date
                habitsConfig.forEach(habit => {
                    if (habit.autoDetect && symbols.includes(habit.autoDetect)) {
                        // Only auto-set if not manually set already
                        if (habitsData[date][habit.id] === undefined) {
                            habitsData[date][habit.id] = true;
                            syncCount++;
                            console.log(`Auto-detected ${habit.name} for ${date} (symbol: ${habit.autoDetect})`);
                        } else {
                            console.log(`${habit.name} already set for ${date}, skipping auto-detection`);
                        }
                    }
                });
            });
            
            if (syncCount > 0) {
                saveHabitsData();
                console.log(`Auto-synced ${syncCount} habits from time log data`);
                console.log('Updated habits data:', habitsData);
            }
        }

        // Data persistence
        function saveTimeData() {
            localStorage.setItem('timeTrackerData', JSON.stringify(timeData));
        }

        function loadTimeData() {
            const saved = localStorage.getItem('timeTrackerData');
            if (saved) {
                timeData = JSON.parse(saved);
            }
        }

        function saveHabitsData() {
            localStorage.setItem('timeTrackerHabits', JSON.stringify(habitsData));
        }

        function loadHabitsData() {
            const saved = localStorage.getItem('timeTrackerHabits');
            if (saved) {
                habitsData = JSON.parse(saved);
            }
        }

        // Export/Import functions
        function exportData() {
            const exportData = {
                timeData: timeData,
                habitsData: habitsData,
                syncPreferences: syncPreferences,
                exportDate: new Date().toISOString()
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `timetracker-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (imported.timeData) {
                                timeData = imported.timeData;
                                saveTimeData();
                            }
                            if (imported.habitsData) {
                                habitsData = imported.habitsData;
                                saveHabitsData();
                            }
                            if (imported.syncPreferences) {
                                syncPreferences = { ...syncPreferences, ...imported.syncPreferences };
                                saveSyncPreferences();
                                loadSyncPreferences();
                            }
                            generateTimeGrid();
                            updateSummary();
                            updateWeeklyView();
                            updateHabitsView();
                            markDataChanged();
                            showAlert('Data imported successfully!', 'success');
                        } catch (error) {
                            showAlert('Error importing data: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearDay() {
            if (confirm('Clear all data for ' + currentDate + '?')) {
                delete timeData[currentDate];
                delete habitsData[currentDate];
                saveTimeData();
                saveHabitsData();
                generateTimeGrid();
                updateSummary();
                updateWeeklyView();
                updateHabitsView();
                markDataChanged();
                showAlert('Day cleared successfully!', 'success');
            }
        }

        // Setup panel functions
        function showSetup() {
            document.getElementById('setupPanel').style.display = 'flex';
        }

        function hideSetup() {
            document.getElementById('setupPanel').style.display = 'none';
        }

        // Add click-outside-to-close functionality
        document.addEventListener('DOMContentLoaded', function() {
            const setupPanel = document.getElementById('setupPanel');
            const setupContent = setupPanel.querySelector('.setup-content');
            
            setupPanel.addEventListener('click', function(e) {
                if (e.target === setupPanel) {
                    hideSetup();
                }
            });
            
            // Prevent closing when clicking inside the content
            setupContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // OneDrive authentication functions
        async function signInToOneDrive() {
            addDebugLog('Sign-in button clicked');
            
            if (!msalInstance) {
                addDebugLog('❌ MSAL instance not available');
                showAlert('Authentication not initialized. Please wait for MSAL to load.', 'error');
                return;
            }

            try {
                addDebugLog('Starting popup login...');
                showAlert('Opening Microsoft sign-in popup...', 'info');
                
                const response = await msalInstance.loginPopup(loginRequest);
                addDebugLog(`✅ Login successful: ${response.account.username}`);
                
                currentAccount = response.account;
                msalInstance.setActiveAccount(currentAccount);
                updateAuthStatus();
                showAlert('Successfully signed in to OneDrive!', 'success');
                
                // Start auto-sync if enabled
                if (syncPreferences.onedrive) {
                    startAutoSync();
                }
                
                // Auto-close setup dialog after successful sign-in
                setTimeout(() => {
                    hideSetup();
                }, 2000);
                
            } catch (error) {
                addDebugLog(`❌ Login failed: ${error.message}`);
                console.error('OneDrive sign-in error:', error);
                
                if (error.errorCode === 'user_cancelled') {
                    showAlert('Sign-in was cancelled', 'info');
                } else {
                    showAlert('OneDrive sign-in failed: ' + error.message, 'error');
                }
            }
        }

        async function signOutFromOneDrive() {
            if (!msalInstance || !currentAccount) return;

            try {
                addDebugLog('Signing out...');
                await msalInstance.logoutPopup({
                    account: currentAccount
                });
                currentAccount = null;
                stopAutoSync();
                updateAuthStatus();
                updateSyncStatus('pending');
                showAlert('Signed out successfully', 'info');
                addDebugLog('✅ Sign-out successful');
            } catch (error) {
                addDebugLog(`❌ Sign-out failed: ${error.message}`);
                console.error('OneDrive sign-out error:', error);
                showAlert('Sign-out failed: ' + error.message, 'error');
            }
        }

        async function testOneDriveConnection() {
            if (!currentAccount) {
                showAlert('Please sign in to OneDrive first', 'error');
                return;
            }

            try {
                addDebugLog('Testing OneDrive connection...');
                const accessToken = await getAccessToken();
                
                const response = await fetch('https://graph.microsoft.com/v1.0/me/drive', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const driveInfo = await response.json();
                    addDebugLog(`✅ OneDrive test successful: ${driveInfo.name}`);
                    document.getElementById('onedriveResult').innerHTML = 
                        `<div class="alert alert-success">✅ OneDrive connection successful! Drive: ${driveInfo.name}</div>`;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                addDebugLog(`❌ OneDrive test failed: ${error.message}`);
                document.getElementById('onedriveResult').innerHTML = 
                    `<div class="alert alert-error">❌ OneDrive connection failed: ${error.message}</div>`;
            }
        }

        async function getAccessToken() {
            if (!msalInstance || !currentAccount) {
                throw new Error('Not signed in to OneDrive');
            }

            try {
                const response = await msalInstance.acquireTokenSilent({
                    scopes: ['https://graph.microsoft.com/Files.ReadWrite'],
                    account: currentAccount
                });
                return response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    // Fallback to interactive token acquisition
                    const response = await msalInstance.acquireTokenPopup({
                        scopes: ['https://graph.microsoft.com/Files.ReadWrite']
                    });
                    return response.accessToken;
                }
                throw error;
            }
        }

        // Auto-sync OneDrive functions
        async function syncToOneDriveAuto() {
            if (!currentAccount) return;

            const accessToken = await getAccessToken();
            
            // Create TimeTracker folder if it doesn't exist
            await createOneDriveFolder(accessToken);
            
            // Sync all dates with data
            const promises = [];
            
            Object.keys(timeData).forEach(date => {
                if (timeData[date] && Object.keys(timeData[date]).length > 0) {
                    const timeFileName = `time-data-${date}.json`;
                    promises.push(
                        fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/TimeTracker/${timeFileName}:/content`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(timeData[date])
                        })
                    );
                }
            });
            
            Object.keys(habitsData).forEach(date => {
                if (habitsData[date] && Object.keys(habitsData[date]).length > 0) {
                    const habitsFileName = `habits-data-${date}.json`;
                    promises.push(
                        fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/TimeTracker/${habitsFileName}:/content`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(habitsData[date])
                        })
                    );
                }
            });
            
            await Promise.all(promises);
        }

        async function loadFromOneDriveAuto() {
            if (!currentAccount) return;

            try {
                const accessToken = await getAccessToken();
                
                // Get list of files in TimeTracker folder
                const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/TimeTracker:/children', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) return; // Folder doesn't exist yet
                
                const files = await response.json();
                
                // Load all time and habits data files
                for (const file of files.value) {
                    if (file.name.startsWith('time-data-') && file.name.endsWith('.json')) {
                        const date = file.name.replace('time-data-', '').replace('.json', '');
                        const fileResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`, {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        
                        if (fileResponse.ok) {
                            const cloudData = await fileResponse.json();
                            // Merge with local data (cloud takes precedence for conflicts)
                            timeData[date] = { ...timeData[date], ...cloudData };
                        }
                    } else if (file.name.startsWith('habits-data-') && file.name.endsWith('.json')) {
                        const date = file.name.replace('habits-data-', '').replace('.json', '');
                        const fileResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`, {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        
                        if (fileResponse.ok) {
                            const cloudData = await fileResponse.json();
                            // Merge with local data (cloud takes precedence for conflicts)
                            habitsData[date] = { ...habitsData[date], ...cloudData };
                        }
                    }
                }
                
                // Save merged data locally
                saveTimeData();
                saveHabitsData();
                
            } catch (error) {
                console.error('Auto-load from OneDrive failed:', error);
            }
        }

        async function createOneDriveFolder(accessToken) {
            try {
                await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'TimeTracker',
                        folder: {}
                    })
                });
            } catch (error) {
                // Folder might already exist, ignore error
            }
        }

        // GitHub auto-sync functions (placeholder - would need GitHub API integration)
        async function syncToGitHubAuto() {
            // Placeholder for GitHub auto-sync
            // Would require GitHub API integration with personal access token
            addDebugLog('GitHub auto-sync not yet implemented');
        }

        async function loadFromGitHubAuto() {
            // Placeholder for GitHub auto-load
            addDebugLog('GitHub auto-load not yet implemented');
        }

        function updateAuthStatus(errorMessage = null) {
            const onedriveStatus = document.getElementById('onedriveStatus');
            const authStatus = document.getElementById('onedriveAuthStatus');
            const signInBtn = document.getElementById('signInBtn');
            const signedInControls = document.getElementById('signedInControls');
            
            if (errorMessage) {
                onedriveStatus.textContent = errorMessage;
                authStatus.textContent = `Status: ${errorMessage}`;
                signInBtn.disabled = true;
                signInBtn.innerHTML = '<span>❌</span><span>Authentication Error</span>';
                signedInControls.style.display = 'none';
            } else if (currentAccount) {
                onedriveStatus.textContent = `Connected as ${currentAccount.username}`;
                authStatus.textContent = `✅ Signed in as: ${currentAccount.username}`;
                signInBtn.style.display = 'none';
                signedInControls.style.display = 'block';
            } else {
                onedriveStatus.textContent = 'Ready - Click Setup to sign in';
                authStatus.textContent = 'Status: Ready to sign in';
                signInBtn.style.display = 'block';
                signInBtn.disabled = false;
                signInBtn.innerHTML = '<span>🔐</span><span>Sign in with Microsoft</span>';
                signedInControls.style.display = 'none';
            }
            
            // Update sync status
            updateSyncStatus(pendingChanges ? 'pending' : 'synced');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '1002';
            alertDiv.style.maxWidth = '300px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 4000);
        }
    </script>
</body>
</html>

