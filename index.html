


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTracker Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" sizes="192x192" href="time-tracker-grid-icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="time-tracker-grid-icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
            margin-top: 12px;
        }

        .date-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 2px;
        }

        .date-nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .date-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .date-input {
            padding: 6px 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            min-width: 140px;
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            white-space: nowrap;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .sync-status {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .sync-dot.connected {
            background: #10b981;
        }

        .sync-dot.disconnected {
            background: #ef4444;
        }

        .sync-dot.syncing {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background: white;
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #475569;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Daily View Styles */
        .daily-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .daily-nav-btn {
            padding: 8px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .daily-nav-btn:hover {
            background: #1d4ed8;
        }

        .daily-date {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }

        .activity-selector {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .activity-selector h3 {
            margin-bottom: 12px;
            color: #1e293b;
            font-size: 16px;
        }

        .activity-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .activity-btn {
            width: 44px;
            height: 44px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .activity-btn:hover {
            border-color: #2563eb;
            transform: translateY(-1px);
        }

        .activity-btn.selected {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .time-grid {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr);
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .grid-header div {
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #374151;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr);
            border-bottom: 1px solid #e5e7eb;
        }

        .grid-row:nth-child(even) {
            background: #f9fafb;
        }

        .hour-label {
            padding: 6px 4px;
            background: #f1f5f9;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .time-cell {
            padding: 6px 4px;
            border-right: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            min-height: 32px;
        }

        .time-cell:hover {
            background: #dbeafe;
        }

        .time-cell.filled {
            background: #bfdbfe;
            color: #1e40af;
        }

        /* Weekly View Styles */
        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .week-nav-btn {
            padding: 8px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .week-nav-btn:hover {
            background: #1d4ed8;
        }

        .week-range {
            font-weight: 600;
            color: #1e293b;
        }

        .weekly-grid {
            background: white;
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .weekly-header {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 11px;
            min-width: 700px;
        }

        .weekly-header div {
            padding: 8px 4px;
            text-align: center;
            border-right: 1px solid #374151;
        }

        .weekly-row {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            border-bottom: 1px solid #e5e7eb;
            min-width: 700px;
        }

        .weekly-row:nth-child(even) {
            background: #f9fafb;
        }

        .weekly-hour {
            padding: 4px 2px;
            background: #f1f5f9;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }

        .weekly-cell {
            padding: 2px;
            border-right: 1px solid #e5e7eb;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1px;
            min-height: 24px;
        }

        .interval-quarter {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .interval-quarter.has-data {
            background: #bfdbfe;
            color: #1e40af;
        }

        .interval-quarter:hover {
            background: #dbeafe;
        }

        /* Habits View Styles */
        .habits-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .habits-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .habits-nav-btn {
            padding: 8px 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .habits-nav-btn:hover {
            background: #1d4ed8;
        }

        .habits-period {
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }

        .habits-grid {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .habits-header {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            background: #1e293b;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .habits-header div {
            padding: 10px 4px;
            text-align: center;
            border-right: 1px solid #374151;
        }

        .habits-row {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            border-bottom: 1px solid #e5e7eb;
        }

        .habits-row:nth-child(even) {
            background: #f9fafb;
        }

        .habit-label {
            padding: 12px 8px;
            background: #f1f5f9;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .habit-cell {
            padding: 8px;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .habit-cell:hover {
            background: #dbeafe;
        }

        .habit-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .habit-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .habit-checkbox.half {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }

        .summary {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .summary h3 {
            margin-bottom: 12px;
            color: #1e293b;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
        }

        .summary-item .symbol {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .summary-item .count {
            font-size: 12px;
            color: #64748b;
        }

        .setup-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .setup-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .setup-section:last-child {
            border-bottom: none;
        }

        .setup-section h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .setup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .alert-success {
            background: #10b981;
        }

        .alert-error {
            background: #ef4444;
        }

        .alert-info {
            background: #3b82f6;
        }

        .alert-warning {
            background: #f59e0b;
        }

        .data-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .data-header h2 {
            font-size: 1.5rem;
            color: #1e293b;
        }

        .data-controls {
            display: flex;
            gap: 8px;
        }

        .data-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .data-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .data-filters input,
        .data-filters select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .data-table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #475569;
            font-size: 12px;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .symbol-cell {
            font-weight: bold;
        }

        .key-cell {
            font-family: monospace;
            font-size: 11px;
            color: #64748b;
        }

        .actions-cell {
            text-align: center;
        }

        .btn-delete {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #ef4444;
        }

        .conflict-row {
            background: #fee2e2 !important;
        }

        .conflict-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .conflict-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }

        .conflict-content h3 {
            margin-bottom: 16px;
        }

        .conflict-entries {
            margin-bottom: 20px;
        }

        .conflict-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 6px;
        }

        .conflict-entry:hover {
            background: #f1f5f9;
        }

        .conflict-symbol {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .conflict-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⏰ TimeTracker Pro</h1>
            <div class="controls">
                <div class="date-controls">
                    <button class="date-nav-btn" onclick="navigateDate(-1)" title="Previous Day">‹</button>
                    <input type="date" id="dateInput" class="date-input">
                    <button class="date-nav-btn" onclick="navigateDate(1)" title="Next Day">›</button>
                </div>
                <button class="btn btn-primary" onclick="showSetup()">⚙️ Setup</button>
                <button class="btn btn-primary" onclick="syncToGitHub()">🐙 GitHub Sync</button>
                <button class="btn btn-primary" onclick="loadFromGitHub()">📥 GitHub Load</button>
                <button class="btn btn-primary" onclick="syncToOneDrive()">☁️ OneDrive Sync</button>
                <button class="btn btn-primary" onclick="loadFromOneDrive()">📥 Load</button>
                <button class="btn btn-primary" onclick="exportData()">📤 Export</button>
                <button class="btn btn-primary" onclick="importData()">📥 Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
            </div>
            <div class="sync-status" id="syncStatus">
                <div class="sync-indicator">
                    <div class="sync-dot disconnected" id="githubDot"></div>
                    <span id="githubStatus">GitHub: Not connected</span>
                </div>
                <div class="sync-indicator">
                    <div class="sync-dot disconnected" id="onedriveDot"></div>
                    <span id="onedriveStatus">OneDrive: Not connected</span>
                </div>
                <div class="sync-indicator">
                    <span id="dataStatus">Local: No data</span>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('daily')">📅 Daily</div>
            <div class="nav-tab" onclick="showTab('weekly')">📊 Weekly</div>
            <div class="nav-tab" onclick="showTab('habits')">📈 Habits</div>
            <div class="nav-tab" onclick="showTab('data')">🗂️ Data</div>
        </div>

        <div class="main-content">
            <!-- Daily View -->
            <div id="dailyView" class="view active">
                <div class="daily-header">
                    <button class="daily-nav-btn" onclick="navigateDate(-1)">
                        ← Previous Day
                    </button>
                    <div class="daily-date" id="dailyDate"></div>
                    <button class="daily-nav-btn" onclick="navigateDate(1)">
                        Next Day →
                    </button>
                </div>

                <div class="activity-selector">
                    <h3>Select Activity Symbol</h3>
                    <div class="activity-buttons" id="activityButtons">
                        <button class="activity-btn" data-symbol="●" title="Wake up">●</button>
                        <button class="activity-btn" data-symbol="✓" title="Work">✓</button>
                        <button class="activity-btn" data-symbol="P" title="Pomodoro">P</button>
                        <button class="activity-btn" data-symbol="M" title="Meditation">M</button>
                        <button class="activity-btn" data-symbol="J" title="Jogging">J</button>
                        <button class="activity-btn" data-symbol="○" title="Social">○</button>
                        <button class="activity-btn" data-symbol="×" title="Clear">×</button>
                    </div>
                </div>

                <div class="time-grid">
                    <div class="grid-header">
                        <div>Hour</div>
                        <div>:00-:15</div>
                        <div>:15-:30</div>
                        <div>:30-:45</div>
                        <div>:45-:00</div>
                    </div>
                    <div id="timeGrid"></div>
                </div>

                <div class="summary" id="summary"></div>
            </div>

            <!-- Weekly View -->
            <div id="weeklyView" class="view">
                <div class="week-navigation">
                    <button class="week-nav-btn" onclick="navigateWeek(-1)">← Previous</button>
                    <div class="week-range" id="weekRange"></div>
                    <button class="week-nav-btn" onclick="navigateWeek(1)">Next →</button>
                </div>

                <div class="weekly-grid">
                    <div class="weekly-header" id="weeklyHeader"></div>
                    <div id="weeklyGrid"></div>
                </div>
            </div>

            <!-- Habits View -->
            <div id="habitsView" class="view">
                <div class="habits-container">
                    <div class="habits-navigation">
                        <button class="habits-nav-btn" onclick="navigateHabits(-1)">← Previous</button>
                        <div class="habits-period" id="habitsPeriod"></div>
                        <button class="habits-nav-btn" onclick="navigateHabits(1)">Next →</button>
                    </div>

                    <div style="text-align: center; margin-bottom: 16px;">
                        <button class="btn btn-success" onclick="syncAllHabitsFromTimeLog(); updateHabitsView(); showAlert('Habits synced from time log!', 'success');">
                            🔄 Sync Habits from Time Log
                        </button>
                    </div>

                    <div class="habits-grid" id="habitsGrid1"></div>
                    <div class="habits-grid" id="habitsGrid2"></div>
                </div>
            </div>

            <!-- Data Management View -->
            <div id="dataView" class="view">
                <div class="data-container">
                    <div class="data-header">
                        <h2>Data Management</h2>
                        <div class="data-controls">
                            <button class="btn btn-primary" onclick="refreshDataView()">🔄 Refresh</button>
                            <button class="btn btn-warning" onclick="findDuplicates()">🔍 Find Duplicates</button>
                            <button class="btn btn-danger" onclick="cleanAllDuplicates()">🧹 Clean Duplicates</button>
                        </div>
                    </div>
                    
                    <div class="data-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Entries:</span>
                            <span id="totalEntries" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Dates with Data:</span>
                            <span id="totalDates" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Duplicates Found:</span>
                            <span id="duplicatesCount" class="stat-value">0</span>
                        </div>
                    </div>

                    <div class="data-filters">
                        <input type="text" id="dateFilter" placeholder="Filter by date (YYYY-MM-DD)" onkeyup="filterDataTable()">
                        <select id="symbolFilter" onchange="filterDataTable()">
                            <option value="">All Symbols</option>
                        </select>
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Key</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel" onclick="hideSetupOnOutsideClick(event)">
            <div class="setup-content">
                <div class="setup-section">
                    <h2>Sync Configuration</h2>
                    <div id="debugLog" style="height: 100px; overflow-y: scroll; border: 1px solid #ccc; padding: 5px; font-size: 10px; background: #f0f0f0; margin-bottom: 10px;"></div>
                    
                    <div id="githubAuth">
                        <h3>GitHub Integration</h3>
                        <p>Connect your GitHub account to automatically sync your time tracking data to your repositories.</p>
                        <div id="githubStatusDisplay">Status: Not Connected</div>
                        
                        <div id="githubConnectForm">
                            <div class="form-group">
                                <label for="githubTokenInput">Personal Access Token</label>
                                <input type="password" id="githubTokenInput" placeholder="Enter your GitHub token">
                            </div>
                            <button class="btn btn-primary" onclick="connectGitHub()">Connect</button>
                        </div>
                        
                        <div id="githubConnected" style="display: none;">
                            <div class="form-group">
                                <label for="repoNameInput">Repository Name</label>
                                <input type="text" id="repoNameInput" placeholder="e.g., my-timetracker-data">
                            </div>
                            <div class="form-group">
                                <label for="fileNameInput">File Name</label>
                                <input type="text" id="fileNameInput" value="timetracker.json">
                            </div>
                            <button class="btn btn-success" onclick="testGitHubConnection()">Test Connection</button>
                            <button class="btn btn-primary" onclick="syncToGitHub()">Sync Now</button>
                            <button class="btn btn-danger" onclick="disconnectGitHub()">Sign Out</button>
                        </div>
                    </div>

                    <div id="oneDriveAuth" style="margin-top: 20px;">
                        <h3>OneDrive Integration</h3>
                        <p>Connect your Microsoft account to sync time logs across devices.</p>
                        <div id="oneDriveStatusDisplay">Status: Not Connected</div>
                        <button class="btn btn-primary" id="oneDriveSignInBtn" onclick="signInOneDrive()">Sign In with Microsoft</button>
                        <button class="btn btn-danger" id="oneDriveSignOutBtn" onclick="signOutOneDrive()" style="display: none;">Sign Out</button>
                    </div>
                </div>

                <div class="setup-actions">
                    <button class="btn btn-secondary" onclick="hideSetup()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <script>
        // Global state
        let timeData = {};
        let habitsData = {};
        let currentDate = '';
        let currentWeekStart = null;
        let currentHabitsWeek = null;
        let selectedSymbol = '✓';

        // GitHub state
        let githubToken = null;
        let githubUser = null;
        let githubRepo = '';
        let githubFile = 'timetracker.json';
        let githubSha = null;

        // OneDrive state
        let msalInstance = null;
        let oneDriveAccount = null;

        // DOM elements
        const dateInputElement = document.getElementById('dateInput');
        const dailyDateElement = document.getElementById('dailyDate');
        const timeGridElement = document.getElementById('timeGrid');
        const summaryElement = document.getElementById('summary');
        const activityButtonsElement = document.getElementById('activityButtons');
        const setupPanelElement = document.getElementById('setupPanel');
        const debugLogElement = document.getElementById('debugLog');

        // Constants
        const HABITS = ['Meditate', 'Workout', 'Read', 'Journal', 'Code'];

        // ===================================================================================
        // INITIALIZATION & CORE LOGIC
        // ===================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            addDebugLog('DOM loaded, initializing app...');
            
            // Load data from local storage
            loadTimeData();
            loadHabitsData();

            // Set initial date
            const today = new Date();
            currentDate = formatDate(today);
            currentWeekStart = getWeekStart(today);
            currentHabitsWeek = getWeekStart(today);
            dateInputElement.value = currentDate;

            // Initialize views
            generateTimeGrid();
            updateDailyView();
            updateWeeklyView();
            updateHabitsView();
            updateDataStatus();
            updateSymbolFilters();

            // Initialize auth
            loadGitHubAuth();
            initializeMSAL();

            // Set up event listeners
            activityButtonsElement.addEventListener('click', handleActivitySelection);
            document.querySelector('.btn-primary[onclick="importData()"').addEventListener('click', () => document.getElementById('importFile').click());

            addDebugLog('Initialization complete.');
        }

        function refreshAllViews() {
            updateDailyView();
            updateWeeklyView();
            updateHabitsView();
            updateDataStatus();
            refreshDataView();
        }

        // ===================================================================================
        // DATE & TIME UTILITIES
        // ===================================================================================

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(date) {
            return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            return new Date(d.setDate(diff));
        }

        function formatTimeKey(timeKey) {
            if (!timeKey || typeof timeKey !== 'string') return 'Invalid';
            const [hour, quarter] = timeKey.split('-').map(Number);
            if (isNaN(hour) || isNaN(quarter)) return 'Invalid';
            const minutes = quarter * 15;
            return `${String(hour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // ===================================================================================
        // DATA MANAGEMENT (LOCAL)
        // ===================================================================================

        function loadTimeData() {
            const savedData = localStorage.getItem('timeData');
            if (savedData) {
                timeData = JSON.parse(savedData);
            }
        }

        function saveTimeData() {
            localStorage.setItem('timeData', JSON.stringify(timeData));
            updateDataStatus();
        }

        function loadHabitsData() {
            const savedData = localStorage.getItem('habitsData');
            if (savedData) {
                habitsData = JSON.parse(savedData);
            }
        }

        function saveHabitsData() {
            localStorage.setItem('habitsData', JSON.stringify(habitsData));
        }

        function exportData() {
            const data = {
                timeData: timeData,
                habitsData: habitsData
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timetracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showAlert('Data exported successfully!', 'success');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.timeData) {
                        timeData = data.timeData;
                        saveTimeData();
                    }
                    if (data.habitsData) {
                        habitsData = data.habitsData;
                        saveHabitsData();
                    }
                    refreshAllViews();
                    showAlert('Data imported successfully!', 'success');
                } catch (error) {
                    showAlert(`Error importing data: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        // ===================================================================================
        // DAILY VIEW
        // ===================================================================================

        function updateDailyView() {
            dailyDateElement.textContent = formatDateDisplay(new Date(currentDate));
            updateTimeGrid();
            updateSummary();
        }

        function generateTimeGrid() {
            timeGridElement.innerHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                const row = document.createElement('div');
                row.className = 'grid-row';

                const hourLabel = document.createElement('div');
                hourLabel.className = 'hour-label';
                hourLabel.textContent = `${String(hour).padStart(2, '0')}:00`;
                row.appendChild(hourLabel);

                for (let quarter = 0; quarter < 4; quarter++) {
                    const cell = document.createElement('div');
                    cell.className = 'time-cell';
                    cell.dataset.hour = hour;
                    cell.dataset.quarter = quarter;
                    cell.addEventListener('click', handleTimeCellClick);
                    row.appendChild(cell);
                }
                timeGridElement.appendChild(row);
            }
        }

        function updateTimeGrid() {
            const dayData = timeData[currentDate] || {};
            document.querySelectorAll('.time-cell').forEach(cell => {
                const { hour, quarter } = cell.dataset;
                const key = `${hour}-${quarter}`;
                if (dayData[key]) {
                    cell.textContent = dayData[key];
                    cell.classList.add('filled');
                } else {
                    cell.textContent = '';
                    cell.classList.remove('filled');
                }
            });
        }

        function handleActivitySelection(event) {
            if (event.target.classList.contains('activity-btn')) {
                document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('selected'));
                event.target.classList.add('selected');
                selectedSymbol = event.target.dataset.symbol;
            }
        }

        function handleTimeCellClick(event) {
            const { hour, quarter } = event.target.dataset;
            const key = `${hour}-${quarter}`;

            if (!timeData[currentDate]) {
                timeData[currentDate] = {};
            }

            if (selectedSymbol === '×') {
                delete timeData[currentDate][key];
            } else {
                timeData[currentDate][key] = selectedSymbol;
            }

            saveTimeData();
            updateTimeGrid();
            updateSummary();
        }

        function updateSummary() {
            const dayData = timeData[currentDate] || {};
            const summary = {};
            let totalMinutes = 0;

            for (const key in dayData) {
                const symbol = dayData[key];
                if (symbol === '●') continue;
                if (!summary[symbol]) {
                    summary[symbol] = 0;
                }
                summary[symbol] += 15;
                totalMinutes += 15;
            }

            summaryElement.innerHTML = '<h3>Daily Summary</h3>';
            const grid = document.createElement('div');
            grid.className = 'summary-grid';

            for (const symbol in summary) {
                const hours = Math.floor(summary[symbol] / 60);
                const minutes = summary[symbol] % 60;
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `
                    <div class="symbol">${symbol}</div>
                    <div class="count">${hours}h ${minutes}m</div>
                `;
                grid.appendChild(item);
            }
            summaryElement.appendChild(grid);
        }

        function navigateDate(direction) {
            const newDate = addDays(new Date(currentDate), direction);
            currentDate = formatDate(newDate);
            dateInputElement.value = currentDate;
            updateDailyView();
        }

        // ===================================================================================
        // WEEKLY VIEW
        // ===================================================================================

        function updateWeeklyView() {
            updateWeeklyHeader();
            updateWeeklyGrid();
        }

        function updateWeeklyHeader() {
            const header = document.getElementById('weeklyHeader');
            header.innerHTML = '';
            const hourCol = document.createElement('div');
            hourCol.textContent = 'Hour';
            header.appendChild(hourCol);

            for (let i = 0; i < 7; i++) {
                const date = addDays(currentWeekStart, i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                const dayCol = document.createElement('div');
                dayCol.textContent = `${dayName} ${dayNum}`;
                header.appendChild(dayCol);
            }
            document.getElementById('weekRange').textContent = `${formatDateDisplay(currentWeekStart)} - ${formatDateDisplay(addDays(currentWeekStart, 6))}`;
        }

        function updateWeeklyGrid() {
            const grid = document.getElementById('weeklyGrid');
            grid.innerHTML = '';

            for (let hour = 0; hour < 24; hour++) {
                const row = document.createElement('div');
                row.className = 'weekly-row';
                const hourLabel = document.createElement('div');
                hourLabel.className = 'weekly-hour';
                hourLabel.textContent = `${String(hour).padStart(2, '0')}:00`;
                row.appendChild(hourLabel);

                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const date = addDays(currentWeekStart, dayIndex);
                    const dateStr = formatDate(date);
                    const dayCell = document.createElement('div');
                    dayCell.className = 'weekly-cell';

                    for (let interval = 0; interval < 4; interval++) {
                        const quarter = document.createElement('div');
                        quarter.className = 'interval-quarter';
                        const key = `${hour}-${interval}`;
                        const data = timeData[dateStr] || {};
                        if (data[key]) {
                            quarter.textContent = data[key];
                            quarter.classList.add('has-data');
                            quarter.title = `${formatTimeKey(key)} - ${data[key]}`;
                        }
                        dayCell.appendChild(quarter);
                    }
                    row.appendChild(dayCell);
                }
                grid.appendChild(row);
            }
        }

        function navigateWeek(direction) {
            currentWeekStart = addDays(currentWeekStart, direction * 7);
            updateWeeklyView();
        }

        // ===================================================================================
        // HABITS VIEW
        // ===================================================================================

        function updateHabitsView() {
            updateHabitsGrid(document.getElementById('habitsGrid1'), currentHabitsWeek);
            const nextWeek = addDays(currentHabitsWeek, 7);
            updateHabitsGrid(document.getElementById('habitsGrid2'), nextWeek);
            document.getElementById('habitsPeriod').textContent = `${formatDateDisplay(currentHabitsWeek)} - ${formatDateDisplay(addDays(nextWeek, 6))}`;
        }

        function updateHabitsGrid(gridElement, weekStart) {
            gridElement.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'habits-header';
            const habitCol = document.createElement('div');
            habitCol.textContent = 'Habit';
            header.appendChild(habitCol);

            for (let i = 0; i < 7; i++) {
                const date = addDays(weekStart, i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                const dayCol = document.createElement('div');
                dayCol.textContent = `${dayName} ${dayNum}`;
                header.appendChild(dayCol);
            }
            gridElement.appendChild(header);

            HABITS.forEach(habit => {
                const row = document.createElement('div');
                row.className = 'habits-row';
                const label = document.createElement('div');
                label.className = 'habit-label';
                label.textContent = habit;
                row.appendChild(label);

                for (let i = 0; i < 7; i++) {
                    const date = formatDate(addDays(weekStart, i));
                    const cell = document.createElement('div');
                    cell.className = 'habit-cell';
                    const checkbox = document.createElement('div');
                    checkbox.className = 'habit-checkbox';
                    const habitStatus = (habitsData[date] && habitsData[date][habit]) || 'none';
                    if (habitStatus === 'done') {
                        checkbox.classList.add('checked');
                        checkbox.textContent = '✓';
                    } else if (habitStatus === 'half') {
                        checkbox.classList.add('half');
                        checkbox.textContent = '½';
                    }
                    checkbox.dataset.date = date;
                    checkbox.dataset.habit = habit;
                    checkbox.addEventListener('click', handleHabitClick);
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                }
                gridElement.appendChild(row);
            });
        }

        function handleHabitClick(event) {
            const { date, habit } = event.target.dataset;
            if (!habitsData[date]) {
                habitsData[date] = {};
            }
            const currentStatus = habitsData[date][habit] || 'none';
            let nextStatus = 'half';
            if (currentStatus === 'half') nextStatus = 'done';
            if (currentStatus === 'done') nextStatus = 'none';
            habitsData[date][habit] = nextStatus;
            saveHabitsData();
            updateHabitsView();
        }

        function syncAllHabitsFromTimeLog() {
            Object.keys(timeData).forEach(date => {
                const dayData = timeData[date];
                const symbols = new Set(Object.values(dayData));
                if (!habitsData[date]) habitsData[date] = {};

                if (symbols.has('M')) habitsData[date]['Meditate'] = 'done';
                if (symbols.has('J')) habitsData[date]['Workout'] = 'done';
            });
            saveHabitsData();
        }

        function navigateHabits(direction) {
            currentHabitsWeek = addDays(currentHabitsWeek, direction * 14);
            updateHabitsView();
        }

        // ===================================================================================
        // DATA MANAGEMENT VIEW
        // ===================================================================================

        function showTab(tabName) {
            document.querySelectorAll('.view').forEach(view => view.style.display = 'none');
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${tabName}View`).style.display = 'block';
            const activeTab = document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`);
            if(activeTab) activeTab.classList.add('active');
            if (tabName === 'data') refreshDataView();
        }

        function refreshDataView() {
            const allEntries = [];
            Object.keys(timeData).forEach(date => {
                Object.keys(timeData[date]).forEach(timeKey => {
                    allEntries.push({ date, timeKey, symbol: timeData[date][timeKey] });
                });
            });

            document.getElementById('totalEntries').textContent = allEntries.length;
            document.getElementById('totalDates').textContent = Object.keys(timeData).length;

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            allEntries.sort((a, b) => `${b.date}-${b.timeKey}`.localeCompare(`${a.date}-${a.timeKey}`)).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${formatTimeKey(entry.timeKey)}</td>
                    <td class="symbol-cell">${entry.symbol}</td>
                    <td class="key-cell">${entry.date}-${entry.timeKey}</td>
                    <td class="actions-cell">
                        <button class="btn-delete" onclick="deleteEntry('${entry.date}', '${entry.timeKey}')">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            findDuplicates(true);
        }

        function deleteEntry(date, timeKey) {
            if (confirm(`Delete entry for ${date} at ${formatTimeKey(timeKey)}?`)) {
                if (timeData[date] && timeData[date][timeKey]) {
                    delete timeData[date][timeKey];
                    if (Object.keys(timeData[date]).length === 0) {
                        delete timeData[date];
                    }
                    saveTimeData();
                    refreshAllViews();
                    showAlert('Entry deleted successfully', 'success');
                }
            }
        }

        function findDuplicates(silent = false) {
            const conflicts = new Map();
            Object.keys(timeData).forEach(date => {
                Object.keys(timeData[date]).forEach(timeKey => {
                    const key = `${date}-${timeKey}`;
                    if (!conflicts.has(key)) conflicts.set(key, []);
                    conflicts.get(key).push(timeData[date][timeKey]);
                });
            });

            let duplicateCount = 0;
            document.querySelectorAll('#dataTableBody tr').forEach(row => row.classList.remove('conflict-row'));

            conflicts.forEach((symbols, key) => {
                if (symbols.length > 1) {
                    duplicateCount++;
                    const [date, timeKey] = key.split(/-(.+)/).slice(0, 2);
                    document.querySelectorAll(`#dataTableBody tr`).forEach(row => {
                        if (row.cells[0].textContent === date && row.cells[1].textContent === formatTimeKey(timeKey)) {
                            row.classList.add('conflict-row');
                        }
                    });
                }
            });

            document.getElementById('duplicatesCount').textContent = duplicateCount;
            if (!silent && duplicateCount > 0) {
                showAlert(`${duplicateCount} duplicate(s) found.`, 'warning');
            }
        }

        function cleanAllDuplicates() {
            if (!confirm('This will automatically remove exact duplicates. Continue?')) return;
            let removedCount = 0;
            Object.keys(timeData).forEach(date => {
                const seen = new Set();
                Object.keys(timeData[date]).forEach(timeKey => {
                    const key = `${timeKey}-${timeData[date][timeKey]}`;
                    if (seen.has(key)) {
                        delete timeData[date][timeKey];
                        removedCount++;
                    } else {
                        seen.add(key);
                    }
                });
            });
            if (removedCount > 0) {
                saveTimeData();
                refreshAllViews();
                showAlert(`Removed ${removedCount} duplicate entries.`, 'success');
            } else {
                showAlert('No exact duplicates found to remove.', 'info');
            }
        }

        function filterDataTable() {
            const dateFilter = document.getElementById('dateFilter').value;
            const symbolFilter = document.getElementById('symbolFilter').value;
            document.querySelectorAll('#dataTableBody tr').forEach(row => {
                const dateMatch = !dateFilter || row.cells[0].textContent.includes(dateFilter);
                const symbolMatch = !symbolFilter || row.cells[2].textContent === symbolFilter;
                row.style.display = dateMatch && symbolMatch ? '' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('symbolFilter').value = '';
            filterDataTable();
        }

        function updateSymbolFilters() {
            const symbols = new Set();
            Object.values(timeData).forEach(dayData => {
                Object.values(dayData).forEach(symbol => symbols.add(symbol));
            });
            const select = document.getElementById('symbolFilter');
            select.innerHTML = '<option value="">All Symbols</option>';
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });
        }

        // ===================================================================================
        // SETUP PANEL & STATUS
        // ===================================================================================

        function showSetup() {
            setupPanelElement.style.display = 'flex';
        }

        function hideSetup() {
            setupPanelElement.style.display = 'none';
        }

        function hideSetupOnOutsideClick(event) {
            if (event.target === setupPanelElement) {
                hideSetup();
            }
        }

        function updateDataStatus() {
            const entryCount = Object.values(timeData).reduce((acc, day) => acc + Object.keys(day).length, 0);
            document.getElementById('dataStatus').textContent = `Local: ${entryCount} entries`;
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function addDebugLog(message) {
            debugLogElement.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugLogElement.scrollTop = debugLogElement.scrollHeight;
        }

        // ===================================================================================
        // GITHUB INTEGRATION
        // ===================================================================================

        function loadGitHubAuth() {
            githubToken = localStorage.getItem('github_token');
            githubRepo = localStorage.getItem('github_repo') || 'timetracker-data';
            githubFile = localStorage.getItem('github_file') || 'timetracker.json';
            if (githubToken) {
                document.getElementById('githubConnectForm').style.display = 'none';
                document.getElementById('githubConnected').style.display = 'block';
                document.getElementById('repoNameInput').value = githubRepo;
                document.getElementById('fileNameInput').value = githubFile;
                updateGitHubStatus(true);
            } else {
                updateGitHubStatus(false);
            }
        }

        async function connectGitHub() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) return showAlert('Please enter a GitHub token.', 'error');
            githubToken = token;
            try {
                const response = await fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${githubToken}` } });
                if (!response.ok) throw new Error('Invalid token');
                githubUser = await response.json();
                localStorage.setItem('github_token', githubToken);
                loadGitHubAuth();
                showAlert(`Connected to GitHub as ${githubUser.login}`, 'success');
            } catch (error) {
                showAlert(`GitHub connection failed: ${error.message}`, 'error');
                githubToken = null;
            }
        }

        function disconnectGitHub() {
            localStorage.removeItem('github_token');
            githubToken = null;
            githubUser = null;
            document.getElementById('githubConnectForm').style.display = 'block';
            document.getElementById('githubConnected').style.display = 'none';
            updateGitHubStatus(false);
            showAlert('Disconnected from GitHub.', 'info');
        }

        async function testGitHubConnection() {
            if (!githubToken) return showAlert('Not connected to GitHub.', 'error');
            githubRepo = document.getElementById('repoNameInput').value.trim();
            localStorage.setItem('github_repo', githubRepo);
            try {
                const response = await fetch(`https://api.github.com/repos/${githubUser.login}/${githubRepo}`, { headers: { 'Authorization': `token ${githubToken}` } });
                if (response.status === 404) {
                    if (confirm(`Repo not found. Create ${githubRepo}?`)) {
                        await createGitHubRepo();
                    }
                } else if (response.ok) {
                    showAlert('Successfully connected to repository.', 'success');
                } else {
                    throw new Error(`Repo access error: ${response.statusText}`);
                }
            } catch (error) {
                showAlert(`Connection test failed: ${error.message}`, 'error');
            }
        }

        async function createGitHubRepo() {
            try {
                const response = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: githubRepo, private: true })
                });
                if (!response.ok) throw new Error(`Repo creation failed: ${response.statusText}`);
                showAlert('Repository created successfully.', 'success');
            } catch (error) {
                showAlert(`Repo creation failed: ${error.message}`, 'error');
            }
        }

        async function syncToGitHub() {
            if (!githubToken) return showAlert('Not connected to GitHub.', 'error');
            addDebugLog('Syncing to GitHub...');
            updateGitHubStatus(null, true);
            try {
                await getGitHubFileSha();
                const content = btoa(JSON.stringify({ timeData, habitsData }));
                const body = { message: `Sync from TimeTracker Pro`, content, sha: githubSha };
                const response = await fetch(`https://api.github.com/repos/${githubUser.login}/${githubRepo}/${githubFile}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) throw new Error(`Sync failed: ${response.statusText}`);
                const data = await response.json();
                githubSha = data.content.sha;
                updateGitHubStatus(true);
                showAlert('Synced to GitHub successfully!', 'success');
            } catch (error) {
                updateGitHubStatus(false);
                showAlert(`GitHub sync failed: ${error.message}`, 'error');
            }
        }

        async function loadFromGitHub() {
            if (!githubToken) return showAlert('Not connected to GitHub.', 'error');
            addDebugLog('Loading from GitHub...');
            updateGitHubStatus(null, true);
            try {
                const response = await fetch(`https://api.github.com/repos/${githubUser.login}/${githubRepo}/${githubFile}`, { headers: { 'Authorization': `token ${githubToken}` } });
                if (!response.ok) throw new Error(`Load failed: ${response.statusText}`);
                const data = await response.json();
                const content = JSON.parse(atob(data.content));
                timeData = content.timeData || {};
                habitsData = content.habitsData || {};
                saveTimeData();
                saveHabitsData();
                refreshAllViews();
                updateGitHubStatus(true);
                showAlert('Loaded from GitHub successfully!', 'success');
            } catch (error) {
                updateGitHubStatus(false);
                showAlert(`GitHub load failed: ${error.message}`, 'error');
            }
        }

        async function getGitHubFileSha() {
            try {
                const response = await fetch(`https://api.github.com/repos/${githubUser.login}/${githubRepo}/${githubFile}`, { headers: { 'Authorization': `token ${githubToken}` } });
                if (response.ok) {
                    const data = await response.json();
                    githubSha = data.sha;
                } else {
                    githubSha = null;
                }
            } catch (error) {
                githubSha = null;
            }
        }

        function updateGitHubStatus(connected, syncing = false) {
            const dot = document.getElementById('githubDot');
            const status = document.getElementById('githubStatus');
            const display = document.getElementById('githubStatusDisplay');
            dot.className = 'sync-dot';
            if (syncing) {
                dot.classList.add('syncing');
                status.textContent = 'GitHub: Syncing...';
                if(display) display.textContent = 'Status: Syncing...';
            } else if (connected) {
                dot.classList.add('connected');
                status.textContent = 'GitHub: Connected';
                if(display) display.textContent = 'Status: Connected';
            } else {
                dot.classList.add('disconnected');
                status.textContent = 'GitHub: Not connected';
                if(display) display.textContent = 'Status: Not Connected';
            }
        }

        // ===================================================================================
        // ONEDRIVE INTEGRATION
        // ===================================================================================

        function initializeMSAL() {
            const msalConfig = {
                auth: {
                    clientId: "YOUR_CLIENT_ID_HERE", // Replace with your Azure App Client ID
                    authority: "https://login.microsoftonline.com/common",
                    redirectUri: window.location.origin,
                },
                cache: {
                    cacheLocation: "localStorage",
                    storeAuthStateInCookie: true,
                }
            };
            msalInstance = new msal.PublicClientApplication(msalConfig);
            handleOneDriveResponse();
        }

        async function handleOneDriveResponse() {
            try {
                const response = await msalInstance.handleRedirectPromise();
                if (response && response.account) {
                    oneDriveAccount = response.account;
                    updateOneDriveStatus(true);
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        oneDriveAccount = accounts[0];
                        updateOneDriveStatus(true);
                    }
                }
            } catch (error) {
                console.error(error);
                updateOneDriveStatus(false);
            }
        }

        function signInOneDrive() {
            const loginRequest = { scopes: ["Files.ReadWrite.AppFolder"] };
            msalInstance.loginRedirect(loginRequest);
        }

        function signOutOneDrive() {
            const logoutRequest = { account: oneDriveAccount };
            msalInstance.logoutRedirect(logoutRequest);
            localStorage.removeItem('msal.account.keys');
            oneDriveAccount = null;
            updateOneDriveStatus(false);
        }

        async function getOneDriveToken() {
            if (!oneDriveAccount) return null;
            const request = { scopes: ["Files.ReadWrite.AppFolder"], account: oneDriveAccount };
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    return msalInstance.acquireTokenRedirect(request).catch(console.error);
                }
                console.error(error);
                return null;
            }
        }

        async function syncToOneDrive() {
            const token = await getOneDriveToken();
            if (!token) return showAlert('OneDrive: Could not get token.', 'error');
            addDebugLog('Syncing to OneDrive...');
            updateOneDriveStatus(null, true);
            try {
                const content = JSON.stringify({ timeData, habitsData });
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${githubFile}:/content`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: content
                });
                if (!response.ok) throw new Error(`Sync failed: ${response.statusText}`);
                updateOneDriveStatus(true);
                showAlert('Synced to OneDrive successfully!', 'success');
            } catch (error) {
                updateOneDriveStatus(false);
                showAlert(`OneDrive sync failed: ${error.message}`, 'error');
            }
        }

        async function loadFromOneDrive() {
            const token = await getOneDriveToken();
            if (!token) return showAlert('OneDrive: Could not get token.', 'error');
            addDebugLog('Loading from OneDrive...');
            updateOneDriveStatus(null, true);
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${githubFile}:/content`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error(`Load failed: ${response.statusText}`);
                const content = await response.json();
                timeData = content.timeData || {};
                habitsData = content.habitsData || {};
                saveTimeData();
                saveHabitsData();
                refreshAllViews();
                updateOneDriveStatus(true);
                showAlert('Loaded from OneDrive successfully!', 'success');
            } catch (error) {
                updateOneDriveStatus(false);
                showAlert(`OneDrive load failed: ${error.message}`, 'error');
            }
        }

        function updateOneDriveStatus(connected, syncing = false) {
            const dot = document.getElementById('onedriveDot');
            const status = document.getElementById('onedriveStatus');
            const display = document.getElementById('oneDriveStatusDisplay');
            const signInBtn = document.getElementById('oneDriveSignInBtn');
            const signOutBtn = document.getElementById('oneDriveSignOutBtn');

            dot.className = 'sync-dot';
            if (syncing) {
                dot.classList.add('syncing');
                status.textContent = 'OneDrive: Syncing...';
                if(display) display.textContent = 'Status: Syncing...';
            } else if (connected) {
                dot.classList.add('connected');
                status.textContent = 'OneDrive: Connected';
                if(display) display.textContent = `Status: Connected as ${oneDriveAccount.name}`;
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';
            } else {
                dot.classList.add('disconnected');
                status.textContent = 'OneDrive: Not connected';
                if(display) display.textContent = 'Status: Not Connected';
                signInBtn.style.display = 'block';
                signOutBtn.style.display = 'none';
            }
        }

    </script>
</body>
</html>


