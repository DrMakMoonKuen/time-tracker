<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTracker Pro - Block A Corrected</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" sizes="192x192" href="time-tracker-grid-icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="time-tracker-grid-icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .date-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .date-nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .date-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .date-input {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #1f2937;
            min-width: 140px;
        }

        .status-bar {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #f1f5f9;
            color: #374151;
        }

        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: white;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .day-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background: #1d4ed8;
        }

        .current-date {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .activity-selector {
            margin-bottom: 20px;
        }

        .activity-selector h3 {
            margin-bottom: 10px;
            color: #374151;
        }

        .activity-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .activity-btn {
            width: 48px;
            height: 48px;
            border: 2px solid #d1d5db;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-btn:hover {
            border-color: #2563eb;
            background: #f0f9ff;
        }

        .activity-btn.selected {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }

        .time-grid {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr);
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
        }

        .grid-header div {
            padding: 8px 4px;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
        }

        .grid-header div:last-child {
            border-right: none;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr);
            border-bottom: 1px solid #e5e7eb;
        }

        .grid-row:last-child {
            border-bottom: none;
        }

        .hour-label {
            padding: 8px 4px;
            font-weight: 500;
            font-size: 12px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-cell {
            padding: 4px;
            border-right: 1px solid #e5e7eb;
            min-height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .time-cell:last-child {
            border-right: none;
        }

        .time-cell:hover {
            background: #f0f9ff;
        }

        .time-cell.has-data {
            background: #bfdbfe;
        }

        .summary-section {
            margin-top: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .summary-section h3 {
            margin-bottom: 10px;
            color: #374151;
        }

        .weekly-grid {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .weekly-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            min-width: 700px;
        }

        .weekly-header div {
            padding: 8px 4px;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
        }

        .weekly-header div:last-child {
            border-right: none;
        }

        .weekly-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            border-bottom: 1px solid #e5e7eb;
            min-width: 700px;
        }

        .weekly-row:last-child {
            border-bottom: none;
        }

        .weekly-hour {
            padding: 6px 4px;
            font-weight: 500;
            font-size: 10px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weekly-cell {
            padding: 2px;
            border-right: 1px solid #e5e7eb;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .weekly-cell:last-child {
            border-right: none;
        }

        .weekly-cell.has-data {
            background: #bfdbfe;
        }

        .habits-grid {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .habits-header {
            display: grid;
            grid-template-columns: 120px repeat(14, 1fr);
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            min-width: 900px;
        }

        .habits-header div {
            padding: 8px 4px;
            font-weight: 600;
            font-size: 11px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
        }

        .habits-header div:last-child {
            border-right: none;
        }

        .habits-row {
            display: grid;
            grid-template-columns: 120px repeat(14, 1fr);
            border-bottom: 1px solid #e5e7eb;
            min-width: 900px;
        }

        .habits-row:last-child {
            border-bottom: none;
        }

        .habit-label {
            padding: 12px 8px;
            font-weight: 500;
            font-size: 13px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }

        .habit-cell {
            padding: 8px;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .habit-cell:last-child {
            border-right: none;
        }

        .habit-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .habit-checkbox:hover {
            border-color: #2563eb;
        }

        .habit-checkbox.checked {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .habit-checkbox.half {
            background: #93c5fd;
            border-color: #2563eb;
            color: white;
        }

        .auto-sync-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }

        .auto-sync-btn:hover {
            background: #047857;
        }

        .data-management {
            max-width: 100%;
        }

        .data-management h2 {
            margin-bottom: 20px;
            color: #1f2937;
        }

        .data-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .data-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .data-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }

        .data-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .data-table-container {
            overflow-x: auto;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .data-table .symbol-cell {
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            width: 60px;
        }

        .data-table .key-cell {
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
            max-width: 120px;
            word-break: break-all;
        }

        .data-table .actions-cell {
            width: 100px;
        }

        .btn-delete {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            body {
                padding: 0;
            }

            .header {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .date-controls {
                flex-direction: row;
                gap: 6px;
            }

            .date-nav-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .date-input {
                min-width: 120px;
                font-size: 12px;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 50px repeat(4, 1fr);
                font-size: 10px;
            }

            .time-cell {
                min-height: 32px;
                font-size: 14px;
            }

            .activity-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .weekly-header,
            .weekly-row {
                min-width: 600px;
            }

            .habits-header {
                grid-template-columns: 100px repeat(14, 1fr);
                font-size: 10px;
            }

            .habits-row {
                grid-template-columns: 100px repeat(14, 1fr);
            }

            .habit-label {
                font-size: 12px;
                padding: 10px 6px;
            }

            .habit-checkbox {
                width: 18px;
                height: 18px;
            }
        }

        /* Samsung Fold 5 Optimizations */
        @media (max-width: 344px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .date-controls {
                gap: 4px;
            }

            .date-nav-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .date-input {
                min-width: 100px;
                font-size: 11px;
                padding: 6px 8px;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 40px repeat(4, 1fr);
            }

            .hour-label {
                font-size: 10px;
                padding: 6px 2px;
            }

            .time-cell {
                min-height: 28px;
                font-size: 12px;
            }

            .activity-btn {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }

            .habits-header {
                grid-template-columns: 80px repeat(14, 1fr);
                font-size: 9px;
            }

            .habits-row {
                grid-template-columns: 80px repeat(14, 1fr);
            }

            .habit-label {
                font-size: 10px;
                padding: 8px 4px;
            }

            .habit-checkbox {
                width: 16px;
                height: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🕐 TimeTracker Pro</h1>
            <div class="date-controls">
                <button class="date-nav-btn" onclick="changeDate(-1)">‹</button>
                <input type="date" id="dateInput" class="date-input" onchange="handleDateChange()">
                <button class="date-nav-btn" onclick="changeDate(1)">›</button>
            </div>
            <div class="status-bar">
                <span id="localStatus">Local: 0 entries</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('daily')">📅 Daily</button>
            <button class="nav-tab" onclick="showTab('weekly')">📊 Weekly</button>
            <button class="nav-tab" onclick="showTab('habits')">📈 Habits</button>
            <button class="nav-tab" onclick="showTab('data')">🗂️ Data</button>
        </div>

        <div class="main-content">
            <!-- Daily View -->
            <div id="daily" class="tab-content active">
                <div class="day-navigation">
                    <button class="nav-btn" onclick="changeDate(-1)">← Previous Day</button>
                    <div class="current-date" id="currentDate">2025-08-18</div>
                    <button class="nav-btn" onclick="changeDate(1)">Next Day →</button>
                </div>

                <div class="activity-selector">
                    <h3>Select Activity Symbol</h3>
                    <div class="activity-buttons">
                        <button class="activity-btn" data-symbol="●" title="Wake up">●</button>
                        <button class="activity-btn" data-symbol="✓" title="Work">✓</button>
                        <button class="activity-btn" data-symbol="P" title="Pomodoro">P</button>
                        <button class="activity-btn" data-symbol="M" title="Meditation">M</button>
                        <button class="activity-btn" data-symbol="J" title="Jogging">J</button>
                        <button class="activity-btn" data-symbol="○" title="Social">○</button>
                        <button class="activity-btn" data-symbol="×" title="Clear">×</button>
                    </div>
                </div>

                <div class="time-grid" id="timeGrid">
                    <!-- Time grid will be generated by JavaScript -->
                </div>

                <div class="summary-section">
                    <h3>Daily Summary</h3>
                    <div id="dailySummary">No activities logged</div>
                </div>
            </div>

            <!-- Weekly View -->
            <div id="weekly" class="tab-content">
                <div class="day-navigation">
                    <button class="nav-btn" onclick="changeWeek(-1)">← Previous Week</button>
                    <div class="current-date" id="currentWeek">2025-08-18 - 2025-08-24</div>
                    <button class="nav-btn" onclick="changeWeek(1)">Next Week →</button>
                </div>

                <div class="weekly-grid" id="weeklyGrid">
                    <!-- Weekly grid will be generated by JavaScript -->
                </div>
            </div>

            <!-- Habits View -->
            <div id="habits" class="tab-content">
                <div class="day-navigation">
                    <button class="nav-btn" onclick="changeHabitPeriod(-1)">← Previous 2 Weeks</button>
                    <div class="current-date" id="currentHabitPeriod">2025-08-18 - 2025-08-31</div>
                    <button class="nav-btn" onclick="changeHabitPeriod(1)">Next 2 Weeks →</button>
                </div>

                <button class="auto-sync-btn" onclick="autoSyncHabits()">🔄 Auto-Sync from Time Log</button>

                <div class="habits-grid" id="habitsGrid">
                    <!-- Habits grid will be generated by JavaScript -->
                </div>
            </div>

            <!-- Data View -->
            <div id="data" class="tab-content">
                <div class="data-management">
                    <h2>Data Management</h2>
                    
                    <div class="data-actions">
                        <button class="data-btn btn-primary" onclick="findDuplicates()">🔍 Find Duplicates</button>
                        <button class="data-btn btn-danger" onclick="cleanDuplicates()">🧹 Clean Duplicates</button>
                        <button class="data-btn btn-success" onclick="exportData()">📤 Export</button>
                        <button class="data-btn btn-secondary" onclick="importData()">📥 Import</button>
                    </div>

                    <div class="data-stats">
                        <div class="stat-item">
                            <div class="stat-label">Total Entries</div>
                            <div class="stat-value" id="totalEntries">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Dates with Data</div>
                            <div class="stat-value" id="datesWithData">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Duplicates Found</div>
                            <div class="stat-value" id="duplicatesFound">0</div>
                        </div>
                    </div>

                    <div class="data-filters">
                        <input type="text" class="filter-input" id="dateFilter" placeholder="Filter by date (YYYY-MM-DD)">
                        <select class="filter-input" id="symbolFilter">
                            <option value="">All Symbols</option>
                            <option value="●">● Wake up</option>
                            <option value="✓">✓ Work</option>
                            <option value="P">P Pomodoro</option>
                            <option value="M">M Meditation</option>
                            <option value="J">J Jogging</option>
                            <option value="○">○ Social</option>
                        </select>
                        <button class="data-btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Key</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let timeData = {};
        let habitsData = {};
        let currentDate = new Date();
        let selectedSymbol = null;

        // Correct habit list from Remarkable 2 screenshots
        const HABITS = [
            'READING',
            'OATMEAL', 
            'JOGGING',
            'WRITING',
            'MEDITATION',
            'STRETCHING',
            'NO DRINK'
        ];

        // Symbol to habit mapping for auto-sync
        const SYMBOL_TO_HABIT = {
            'J': 'JOGGING',
            'M': 'MEDITATION'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadTimeData();
            loadHabitsData();
            setCurrentDate();
            generateTimeGrid();
            updateAllViews();
            updateDataStatus();
        });

        // Date handling functions
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function getWeekStart(date) {
            const result = new Date(date);
            const day = result.getDay();
            const diff = result.getDate() - day + (day === 0 ? -6 : 1); // Monday start
            result.setDate(diff);
            return result;
        }

        // Time key functions
        function createTimeKey(hour, quarter) {
            return `${hour}-${quarter}`;
        }

        function formatTimeKey(timeKey) {
            if (!timeKey || typeof timeKey !== 'string') {
                return 'Invalid Time';
            }
            
            const parts = timeKey.split('-');
            if (parts.length !== 2) {
                return 'Invalid Time';
            }
            
            const hour = parseInt(parts[0], 10);
            const quarter = parseInt(parts[1], 10);
            
            if (isNaN(hour) || isNaN(quarter)) {
                return 'Invalid Time';
            }
            
            const minutes = quarter * 15;
            const displayHour = hour >= 24 ? hour - 24 : hour;
            
            return `${displayHour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Date navigation
        function setCurrentDate() {
            const dateStr = formatDate(currentDate);
            document.getElementById('dateInput').value = dateStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        function changeDate(days) {
            currentDate = addDays(currentDate, days);
            setCurrentDate();
            updateAllViews();
        }

        function handleDateChange() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput.value) {
                currentDate = parseDate(dateInput.value);
                setCurrentDate();
                updateAllViews();
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update views based on tab
            if (tabName === 'weekly') {
                updateWeeklyView();
            } else if (tabName === 'habits') {
                updateHabitsView();
            } else if (tabName === 'data') {
                updateDataView();
            }
        }

        // Activity selection
        function selectSymbol(symbol) {
            selectedSymbol = symbol;
            
            // Update button states
            const buttons = document.querySelectorAll('.activity-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.symbol === symbol) {
                    btn.classList.add('selected');
                }
            });
        }

        // Time grid generation (5AM-4AM)
        function generateTimeGrid() {
            const grid = document.getElementById('timeGrid');
            
            // Create header
            const header = document.createElement('div');
            header.className = 'grid-header';
            header.innerHTML = `
                <div>Hour</div>
                <div>:00-:15</div>
                <div>:15-:30</div>
                <div>:30-:45</div>
                <div>:45-:00</div>
            `;
            grid.appendChild(header);
            
            // Create rows for 24 hours starting from 5AM
            for (let i = 0; i < 24; i++) {
                const hour = (i + 5) % 24; // Start from 5AM
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                const hourLabel = document.createElement('div');
                hourLabel.className = 'hour-label';
                hourLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                row.appendChild(hourLabel);
                
                // Create 4 quarter-hour cells
                for (let quarter = 0; quarter < 4; quarter++) {
                    const cell = document.createElement('div');
                    cell.className = 'time-cell';
                    cell.dataset.hour = hour;
                    cell.dataset.quarter = quarter;
                    cell.onclick = () => toggleTimeCell(hour, quarter);
                    row.appendChild(cell);
                }
                
                grid.appendChild(row);
            }
            
            // Add activity button event listeners
            const activityButtons = document.querySelectorAll('.activity-btn');
            activityButtons.forEach(btn => {
                btn.onclick = () => selectSymbol(btn.dataset.symbol);
            });
        }

        // Time cell toggle
        function toggleTimeCell(hour, quarter) {
            if (!selectedSymbol) {
                alert('Please select an activity symbol first');
                return;
            }
            
            const dateStr = formatDate(currentDate);
            const timeKey = createTimeKey(hour, quarter);
            
            if (!timeData[dateStr]) {
                timeData[dateStr] = {};
            }
            
            if (selectedSymbol === '×') {
                // Clear cell
                delete timeData[dateStr][timeKey];
                if (Object.keys(timeData[dateStr]).length === 0) {
                    delete timeData[dateStr];
                }
            } else {
                // Set symbol
                timeData[dateStr][timeKey] = selectedSymbol;
            }
            
            saveTimeData();
            updateAllViews();
            
            // Auto-sync habits for J and M symbols
            if (SYMBOL_TO_HABIT[selectedSymbol]) {
                autoSyncSingleHabit(dateStr, selectedSymbol);
            }
        }

        // Update daily view
        function updateDailyView() {
            const dateStr = formatDate(currentDate);
            const dayData = timeData[dateStr] || {};
            
            // Update time cells
            const cells = document.querySelectorAll('.time-cell');
            cells.forEach(cell => {
                const hour = parseInt(cell.dataset.hour);
                const quarter = parseInt(cell.dataset.quarter);
                const timeKey = createTimeKey(hour, quarter);
                
                if (dayData[timeKey]) {
                    cell.textContent = dayData[timeKey];
                    cell.classList.add('has-data');
                } else {
                    cell.textContent = '';
                    cell.classList.remove('has-data');
                }
            });
            
            // Update summary
            updateDailySummary();
        }

        // Update daily summary (excluding Wake up ●)
        function updateDailySummary() {
            const dateStr = formatDate(currentDate);
            const dayData = timeData[dateStr] || {};
            
            const symbolCounts = {};
            let totalMinutes = 0;
            
            Object.values(dayData).forEach(symbol => {
                if (symbol !== '●') { // Exclude Wake up from summary
                    symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
                    totalMinutes += 15;
                }
            });
            
            const summaryDiv = document.getElementById('dailySummary');
            
            if (totalMinutes === 0) {
                summaryDiv.textContent = 'No activities logged';
                return;
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let summaryText = `Total: ${hours}h ${minutes}m\n`;
            
            Object.entries(symbolCounts).forEach(([symbol, count]) => {
                const symbolMinutes = count * 15;
                const symbolHours = Math.floor(symbolMinutes / 60);
                const symbolMins = symbolMinutes % 60;
                summaryText += `${symbol}: ${symbolHours}h ${symbolMins}m (${count} slots)\n`;
            });
            
            summaryDiv.style.whiteSpace = 'pre-line';
            summaryDiv.textContent = summaryText;
        }

        // Weekly view functions
        function changeWeek(weeks) {
            currentDate = addDays(currentDate, weeks * 7);
            setCurrentDate();
            updateWeeklyView();
        }

        function updateWeeklyView() {
            const weekStart = getWeekStart(currentDate);
            const weekEnd = addDays(weekStart, 6);
            
            document.getElementById('currentWeek').textContent = 
                `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
            
            generateWeeklyGrid();
        }

        function generateWeeklyGrid() {
            const grid = document.getElementById('weeklyGrid');
            grid.innerHTML = '';
            
            const weekStart = getWeekStart(currentDate);
            
            // Create header
            const header = document.createElement('div');
            header.className = 'weekly-header';
            header.innerHTML = '<div>Hour</div>';
            
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            for (let i = 0; i < 7; i++) {
                const date = addDays(weekStart, i);
                const div = document.createElement('div');
                div.innerHTML = `${dayNames[i]}<br>${formatDate(date).slice(5)}`;
                header.appendChild(div);
            }
            grid.appendChild(header);
            
            // Create rows for 24 hours starting from 5AM
            for (let i = 0; i < 24; i++) {
                const hour = (i + 5) % 24;
                const row = document.createElement('div');
                row.className = 'weekly-row';
                
                const hourLabel = document.createElement('div');
                hourLabel.className = 'weekly-hour';
                hourLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                row.appendChild(hourLabel);
                
                // Create cells for each day
                for (let day = 0; day < 7; day++) {
                    const date = addDays(weekStart, day);
                    const dateStr = formatDate(date);
                    const dayData = timeData[dateStr] || {};
                    
                    const cell = document.createElement('div');
                    cell.className = 'weekly-cell';
                    
                    // Show symbols for this hour (all quarters)
                    const symbols = [];
                    for (let quarter = 0; quarter < 4; quarter++) {
                        const timeKey = createTimeKey(hour, quarter);
                        if (dayData[timeKey]) {
                            symbols.push(dayData[timeKey]);
                        }
                    }
                    
                    if (symbols.length > 0) {
                        cell.textContent = symbols.join('');
                        cell.classList.add('has-data');
                    }
                    
                    row.appendChild(cell);
                }
                
                grid.appendChild(row);
            }
        }

        // Habits view functions
        function changeHabitPeriod(periods) {
            currentDate = addDays(currentDate, periods * 14);
            setCurrentDate();
            updateHabitsView();
        }

        function updateHabitsView() {
            const periodStart = getWeekStart(currentDate);
            const periodEnd = addDays(periodStart, 13);
            
            document.getElementById('currentHabitPeriod').textContent = 
                `${formatDate(periodStart)} - ${formatDate(periodEnd)}`;
            
            generateHabitsGrid();
        }

        function generateHabitsGrid() {
            const grid = document.getElementById('habitsGrid');
            grid.innerHTML = '';
            
            const periodStart = getWeekStart(currentDate);
            
            // Create header
            const header = document.createElement('div');
            header.className = 'habits-header';
            header.innerHTML = '<div>Habit</div>';
            
            // Add day numbers (01-14)
            for (let i = 0; i < 14; i++) {
                const div = document.createElement('div');
                div.textContent = (i + 1).toString().padStart(2, '0');
                header.appendChild(div);
            }
            grid.appendChild(header);
            
            // Create rows for each habit
            HABITS.forEach(habit => {
                const row = document.createElement('div');
                row.className = 'habits-row';
                
                const habitLabel = document.createElement('div');
                habitLabel.className = 'habit-label';
                habitLabel.textContent = habit;
                row.appendChild(habitLabel);
                
                // Create cells for 14 days
                for (let day = 0; day < 14; day++) {
                    const date = addDays(periodStart, day);
                    const dateStr = formatDate(date);
                    
                    const cell = document.createElement('div');
                    cell.className = 'habit-cell';
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'habit-checkbox';
                    checkbox.onclick = () => toggleHabit(habit, dateStr, checkbox);
                    
                    // Set initial state
                    const habitKey = `${dateStr}-${habit}`;
                    const state = habitsData[habitKey] || 'none';
                    
                    if (state === 'checked') {
                        checkbox.classList.add('checked');
                        checkbox.textContent = '✓';
                    } else if (state === 'half') {
                        checkbox.classList.add('half');
                        checkbox.textContent = '◐';
                    }
                    
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                }
                
                grid.appendChild(row);
            });
        }

        function toggleHabit(habit, dateStr, checkbox) {
            const habitKey = `${dateStr}-${habit}`;
            const currentState = habitsData[habitKey] || 'none';
            
            let newState;
            if (currentState === 'none') {
                newState = 'half';
                checkbox.classList.add('half');
                checkbox.textContent = '◐';
            } else if (currentState === 'half') {
                newState = 'checked';
                checkbox.classList.remove('half');
                checkbox.classList.add('checked');
                checkbox.textContent = '✓';
            } else {
                newState = 'none';
                checkbox.classList.remove('checked', 'half');
                checkbox.textContent = '';
            }
            
            if (newState === 'none') {
                delete habitsData[habitKey];
            } else {
                habitsData[habitKey] = newState;
            }
            
            saveHabitsData();
        }

        // Auto-sync habits from time log
        function autoSyncHabits() {
            const periodStart = getWeekStart(currentDate);
            let syncCount = 0;
            
            // Check 14 days
            for (let day = 0; day < 14; day++) {
                const date = addDays(periodStart, day);
                const dateStr = formatDate(date);
                const dayData = timeData[dateStr] || {};
                
                // Check for J and M symbols
                Object.values(dayData).forEach(symbol => {
                    if (SYMBOL_TO_HABIT[symbol]) {
                        const habit = SYMBOL_TO_HABIT[symbol];
                        const habitKey = `${dateStr}-${habit}`;
                        
                        // Only auto-sync if not already set
                        if (!habitsData[habitKey]) {
                            habitsData[habitKey] = 'checked';
                            syncCount++;
                        }
                    }
                });
            }
            
            if (syncCount > 0) {
                saveHabitsData();
                updateHabitsView();
                alert(`Auto-synced ${syncCount} habit entries from time log`);
            } else {
                alert('No new habits to sync from time log');
            }
        }

        function autoSyncSingleHabit(dateStr, symbol) {
            if (SYMBOL_TO_HABIT[symbol]) {
                const habit = SYMBOL_TO_HABIT[symbol];
                const habitKey = `${dateStr}-${habit}`;
                
                // Only auto-sync if not already set
                if (!habitsData[habitKey]) {
                    habitsData[habitKey] = 'checked';
                    saveHabitsData();
                    
                    // Update habits view if it's currently active
                    const habitsTab = document.getElementById('habits');
                    if (habitsTab.classList.contains('active')) {
                        updateHabitsView();
                    }
                }
            }
        }

        // Data management functions
        function updateDataView() {
            updateDataStats();
            refreshDataTable();
        }

        function updateDataStats() {
            const totalEntries = Object.values(timeData).reduce((total, dayData) => 
                total + Object.keys(dayData).length, 0);
            
            const datesWithData = Object.keys(timeData).length;
            
            document.getElementById('totalEntries').textContent = totalEntries;
            document.getElementById('datesWithData').textContent = datesWithData;
        }

        function refreshDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            const dateFilter = document.getElementById('dateFilter').value;
            const symbolFilter = document.getElementById('symbolFilter').value;
            
            const entries = [];
            
            Object.entries(timeData).forEach(([date, dayData]) => {
                Object.entries(dayData).forEach(([timeKey, symbol]) => {
                    if ((!dateFilter || date.includes(dateFilter)) &&
                        (!symbolFilter || symbol === symbolFilter)) {
                        entries.push({
                            date,
                            timeKey,
                            symbol,
                            key: `${date}-${timeKey}`
                        });
                    }
                });
            });
            
            entries.sort((a, b) => {
                if (a.date !== b.date) return b.date.localeCompare(a.date);
                return a.timeKey.localeCompare(b.timeKey);
            });
            
            entries.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${formatTimeKey(entry.timeKey)}</td>
                    <td class="symbol-cell">${entry.symbol}</td>
                    <td class="key-cell">${entry.key}</td>
                    <td class="actions-cell">
                        <button class="btn-delete" onclick="deleteEntry('${entry.date}', '${entry.timeKey}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteEntry(date, timeKey) {
            if (confirm(`Delete entry for ${date} at ${formatTimeKey(timeKey)}?`)) {
                if (timeData[date] && timeData[date][timeKey]) {
                    delete timeData[date][timeKey];
                    
                    if (Object.keys(timeData[date]).length === 0) {
                        delete timeData[date];
                    }
                    
                    saveTimeData();
                    updateAllViews();
                    alert('Entry deleted successfully');
                }
            }
        }

        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('symbolFilter').value = '';
            refreshDataTable();
        }

        function findDuplicates() {
            // Implementation for finding duplicates
            alert('Duplicate detection feature');
        }

        function cleanDuplicates() {
            // Implementation for cleaning duplicates
            alert('Duplicate cleaning feature');
        }

        function exportData() {
            const data = {
                timeData,
                habitsData,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timetracker-backup-${formatDate(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.timeData) {
                            timeData = { ...timeData, ...data.timeData };
                        }
                        if (data.habitsData) {
                            habitsData = { ...habitsData, ...data.habitsData };
                        }
                        
                        saveTimeData();
                        saveHabitsData();
                        updateAllViews();
                        
                        alert('Data imported successfully');
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Storage functions
        function saveTimeData() {
            localStorage.setItem('timeTrackerData', JSON.stringify(timeData));
            updateDataStatus();
        }

        function loadTimeData() {
            const saved = localStorage.getItem('timeTrackerData');
            if (saved) {
                timeData = JSON.parse(saved);
            }
        }

        function saveHabitsData() {
            localStorage.setItem('timeTrackerHabits', JSON.stringify(habitsData));
        }

        function loadHabitsData() {
            const saved = localStorage.getItem('timeTrackerHabits');
            if (saved) {
                habitsData = JSON.parse(saved);
            }
        }

        function updateDataStatus() {
            const totalEntries = Object.values(timeData).reduce((total, dayData) => 
                total + Object.keys(dayData).length, 0);
            
            document.getElementById('localStatus').textContent = `Local: ${totalEntries} entries`;
        }

        // Update all views
        function updateAllViews() {
            updateDailyView();
            updateDataStatus();
            
            // Update other views if they're active
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                if (activeTab.id === 'weekly') {
                    updateWeeklyView();
                } else if (activeTab.id === 'habits') {
                    updateHabitsView();
                } else if (activeTab.id === 'data') {
                    updateDataView();
                }
            }
        }
    </script>
</body>
</html>

